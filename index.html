<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DeutscheGlobal Bank — Digital Banking</title>
  <meta name="description" content="DeutscheGlobal Bank — secure, mobile-first digital banking. Professional banking services, accounts, payments, investments and support." />
  <!-- Fonts & icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- jsPDF for receipts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- EmailJS for notifications -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <style>
    /*
      Upgraded styles: Enhanced glassmorphism, dark mode support, animations, improved responsiveness.
      - Added dark mode variables and toggle.
      - Added transitions for modals and cards.
      - Improved hero layout and services grid.
      - Enhanced accessibility with better contrasts and focus styles.
    */
    :root{
      --bg: linear-gradient(180deg,#f5f7fb 0%, #eef3fb 100%);
      --header-bg: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.6));
      --glass: rgba(255,255,255,0.62);
      --glass-2: rgba(255,255,255,0.85);
      --primary: #003366;
      --accent: #ff6600;
      --muted: #6b7280;
      --card-shadow: 0 8px 30px rgba(2,6,23,0.08);
      --radius: 14px;
      --glass-border: rgba(255,255,255,0.5);
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    [data-theme="dark"] {
      --bg: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
      --header-bg: linear-gradient(180deg, rgba(26,32,44,0.75), rgba(45,55,72,0.6));
      --glass: rgba(45,55,72,0.62);
      --glass-2: rgba(45,55,72,0.85);
      --primary: #4299e1;
      --accent: #ed64a6;
      --muted: #a0aec0;
      --card-shadow: 0 8px 30px rgba(0,0,0,0.3);
      --glass-border: rgba(45,55,72,0.5);
      color: #e2e8f0;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);-webkit-font-smoothing:antialiased;color:#071423}
    [data-theme="dark"] body { color: #e2e8f0; }
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:0 1rem}
    .skip{position:absolute;left:-999px} .skip:focus{left:1rem;top:1rem;padding:.4rem .6rem;background:white;border-radius:6px;box-shadow:var(--card-shadow)}

    /* Header */
    header.site-header{
      position:sticky;top:0;z-index:120;
      background:var(--header-bg);
      backdrop-filter: blur(6px);
      border-bottom:1px solid rgba(2,6,23,0.04);
    }
    [data-theme="dark"] header.site-header { border-bottom:1px solid rgba(255,255,255,0.1); }
    .header-inner{display:flex;align-items:center;justify-content:space-between;padding:.7rem 1rem;gap:.5rem}
    .brand{display:flex;align-items:center;gap:.6rem;cursor:pointer;user-select:none}
    .brand .mark{
      width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:white;
      background:linear-gradient(135deg,var(--primary),#0066cc);font-size:1.1rem;font-weight:800;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }
    .brand .titles{line-height:1}
    .brand .title{font-weight:800;font-size:1rem}
    .brand .subtitle{font-size:.78rem;color:var(--muted);margin-top:2px}

    .header-actions{display:flex;align-items:center;gap:.6rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .9rem;border-radius:10px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer;transition:background 0.2s ease, transform 0.1s ease;}
    .btn:hover { transform: translateY(-2px); }
    .btn.secondary{background:transparent;border:1px solid rgba(2,6,23,0.06);color:var(--primary);font-weight:700}
    [data-theme="dark"] .btn.secondary { border:1px solid rgba(255,255,255,0.1); color:var(--primary); }
    .icon-btn{background:transparent;border-radius:10px;padding:.5rem;color:var(--muted);border:1px solid rgba(2,6,23,0.04);transition:background 0.2s ease;}
    [data-theme="dark"] .icon-btn { border:1px solid rgba(255,255,255,0.1); }

    /* Hero / landing */
    .hero{display:grid;grid-template-columns:1fr;gap:1rem;padding:1rem 0;transition:opacity 0.3s ease;}
    .hero-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.55));
      border-radius:var(--radius);box-shadow:var(--card-shadow);padding:1rem;border:1px solid var(--glass-border);transition:box-shadow 0.2s ease;
    }
    .hero-card:hover { box-shadow: 0 12px 40px rgba(2,6,23,0.12); }
    .hero-grid{display:grid;grid-template-columns:1fr;gap:.8rem}
    .hero h1{margin:0;font-size:1.5rem;line-height:1.05}
    .hero p.lead{color:var(--muted);margin-top:.5rem}

    .services{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem;margin-top:.7rem}
    .service{background:var(--glass-2);padding:.65rem;border-radius:12px;box-shadow:var(--card-shadow);border:1px solid rgba(255,255,255,0.6);transition:transform 0.2s ease;}
    .service:hover { transform: translateY(-4px); }
    .service h4{margin:0;font-size:1rem}
    .service p{color:var(--muted);margin-top:.45rem;font-size:.92rem}

    .visuals{display:flex;gap:.6rem;margin-top:.6rem}
    .visuals img{width:100%;height:120px;object-fit:cover;border-radius:10px;box-shadow:var(--card-shadow);transition:transform 0.3s ease;}
    .visuals img:hover { transform: scale(1.05); }

    /* Cards preview (Visa/Mastercard/Amex) */
    .card-stack{position:relative;height:180px;margin-top:.9rem}
    .card{
      position:absolute;width:320px;height:180px;border-radius:14px;color:white;padding:1rem;display:flex;flex-direction:column;justify-content:space-between;
      box-shadow:0 12px 30px rgba(2,6,23,0.12);
      transform-origin:center;transition:transform 0.2s ease;
    }
    .card:hover { transform: translateY(-5px) rotate(0deg) !important; }
    .card .brand{display:flex;align-items:center;gap:.6rem}
    .card .number{font-weight:800;font-size:1.35rem;letter-spacing:2px}
    .card.visa{background:linear-gradient(135deg,#113a63,#0066cc);left:0;top:0;transform:rotate(-6deg)}
    .card.mc{background:linear-gradient(135deg,#bd3e29,#ff6f2d);right:0;top:18px;transform:rotate(6deg);width:300px;height:160px}
    .card.amex{background:linear-gradient(135deg,#0da3ad,#06b6d4);left:20px;bottom:0;transform:rotate(-2deg);width:280px;height:150px}

    /* App shell placeholder (hidden until sign in) */
    .app-shell{display:none;margin-top:1rem}
    .app-grid{display:grid;grid-template-columns:1fr;gap:1rem}
    .onboarding{background:var(--glass-2);padding:1rem;border-radius:12px;border:1px solid rgba(255,255,255,0.6);box-shadow:var(--card-shadow);transition:box-shadow 0.2s ease;}
    .onboarding:hover { box-shadow: 0 12px 40px rgba(2,6,23,0.12); }

    /* footer */
    footer.site-footer{margin-top:1rem;padding:1rem 0;color:var(--muted);font-size:.92rem;border-top:1px solid rgba(2,6,23,0.04)}
    [data-theme="dark"] footer.site-footer { border-top:1px solid rgba(255,255,255,0.1); }
    footer .foot-grid{display:flex;flex-wrap:wrap;gap:1rem;justify-content:space-between;align-items:center}

    /* Modal basics with animations */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:220;transition:opacity 0.3s ease, visibility 0.3s ease;opacity:0;visibility:hidden;}
    .modal-backdrop.show { opacity:1; visibility:visible; }
    [data-theme="dark"] .modal-backdrop { background:rgba(0,0,0,0.65); }
    .modal{background:linear-gradient(180deg,rgba(255,255,255,0.98),white);border-radius:12px;padding:1rem;max-width:820px;width:100%;box-shadow:var(--card-shadow);border:1px solid rgba(2,6,23,0.04);transform:scale(0.95);opacity:0;transition:transform 0.3s ease, opacity 0.3s ease;}
    .modal-backdrop.show .modal { transform:scale(1); opacity:1; }
    [data-theme="dark"] .modal { background:linear-gradient(180deg,rgba(45,55,72,0.98),#2d3748); border:1px solid rgba(255,255,255,0.1); }
    .modal h3{margin:0}
    .input{width:100%;padding:.6rem;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin-top:.5rem;transition:border 0.2s ease;}
    .input:focus { border-color:var(--primary); outline:none; }
    [data-theme="dark"] .input { border:1px solid rgba(255,255,255,0.1); background:rgba(26,32,44,0.5); color:#e2e8f0; }

    /* small screens first; larger screens adapt */
    @media(min-width:880px){
      .hero{grid-template-columns:1fr 420px}
      .hero-grid{grid-template-columns:1fr}
      .services{grid-template-columns:repeat(3,1fr)}
      .visuals img{height:160px}
      .app-grid{grid-template-columns:260px 1fr}
      .card-stack{height:220px}
    }
  </style>
</head>

<body>
  <a class="skip" href="#main">Skip to main content</a>

  <header class="site-header" role="banner">
    <div class="container header-inner">
      <div class="brand" id="siteLogo" tabindex="0" role="button" aria-label="DeutscheGlobal Bank logo — triple-click for secure admin">
        <div class="mark"><i class="fa-solid fa-building-columns"></i></div>
        <div class="titles">
          <div class="title">DeutscheGlobal Bank</div>
          <div class="subtitle">Digital banking & premium services</div>
        </div>
      </div>

      <div class="header-actions" role="toolbar" aria-label="Top actions">
        <button id="openContact" class="btn secondary" aria-haspopup="dialog"><i class="fa-solid fa-phone"></i> Contact</button>
        <button id="themeToggle" class="icon-btn" aria-label="Toggle dark mode"><i class="fa-solid fa-moon"></i></button>
        <button id="openSignIn" class="btn"><i class="fa-solid fa-right-to-bracket"></i> Sign in</button>
      </div>
    </div>
  </header>

  <main id="main" class="container" role="main" aria-live="polite">
    <!-- HERO / LANDING -->
    <section id="landing" class="hero" aria-labelledby="heroHeading">
      <div class="hero-card">
        <div class="hero-grid">
          <div>
            <h1 id="heroHeading">Banking crafted for your life</h1>
            <p class="lead">Modern accounts, global card acceptance and personalized financial tools — available on mobile and desktop. Secure, compliant, and designed for members across Germany and Europe.</p>

            <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.6rem">
              <button id="ctaOpenRegister" class="btn"><i class="fa-solid fa-user-plus"></i> Open an account</button>
              <button id="ctaLearnMore" class="btn secondary"><i class="fa-solid fa-circle-info"></i> Learn more</button>
            </div>

            <div class="services" role="list" aria-label="Our services" style="margin-top:1rem">
              <div class="service" role="listitem">
                <h4>Accounts & Cards</h4>
                <p>Current, savings and business accounts with physical and virtual card options.</p>
              </div>
              <div class="service" role="listitem">
                <h4>Payments & FX</h4>
                <p>Fast internal transfers, SEPA payments and multi-currency wallet management.</p>
              </div>
              <div class="service" role="listitem">
                <h4>Investments & Loans</h4>
                <p>Portfolio tools, savings plans and tailored lending with clear terms.</p>
              </div>
            </div>
          </div>

          <aside>
            <!-- Card stack with well-known card brands -->
            <div class="card-stack" aria-hidden="true">
              <div class="card visa" role="img" aria-label="Visa debit card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div style="font-weight:700">DeutscheGlobal</div>
                  <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Visa_2014_logo_detail.svg" alt="Visa" style="height:20px;filter:brightness(1) saturate(1);"/>
                </div>
                <div class="number">**** **** **** 2345</div>
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div style="font-size:.82rem">Valid THRU 12/28</div>
                  <div style="font-size:.9rem">S. Meier</div>
                </div>
              </div>

              <div class="card mc" role="img" aria-label="Mastercard credit card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div style="font-weight:700">DeutscheGlobal</div>
                  <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Mastercard-logo.png" alt="Mastercard" style="height:20px;filter:brightness(1)"/>
                </div>
                <div class="number">**** **** **** 9876</div>
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div style="font-size:.82rem">Valid THRU 07/27</div>
                  <div style="font-size:.9rem">A. Schmidt</div>
                </div>
              </div>

              <div class="card amex" role="img" aria-label="American Express corporate card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div style="font-weight:800">DGB</div>
                  <img src="https://upload.wikimedia.org/wikipedia/commons/3/30/American_Express_logo.svg" alt="Amex" style="height:20px;filter:brightness(1)"/>
                </div>
                <div class="number">**** **** **** 4521</div>
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div style="font-size:.75rem">Valid THRU 10/29</div>
                  <div style="font-size:.8rem">Acme GmbH</div>
                </div>
              </div>
            </div>

            <!-- a gallery/people images (Unsplash) -->
            <div class="visuals" aria-hidden="false">
              <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=800&auto=format&fit=crop" alt="Smiling customer 1" />
              <img src="https://images.unsplash.com/photo-1531123414780-f0b6c9aee7b3?q=80&w=800&auto=format&fit=crop" alt="Business client" />
            </div>
          </aside>
        </div>
      </div>
    </section>

    <!-- App shell (hidden until authenticated) -->
    <section id="appShell" class="app-shell" aria-hidden="true">
      <div class="app-grid">
        <nav id="primaryNav" aria-label="Primary navigation">
          <!-- left nav will be rendered in next chunk -->
          <div class="onboarding">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div id="uNamePreview" style="font-weight:700">Welcome</div>
                <div id="uMailPreview" style="color:var(--muted);font-size:.9rem">user@example.com</div>
              </div>
              <div id="uBalancePreview" style="text-align:right">
                <div style="color:var(--muted);font-size:.8rem">Total</div>
                <div style="font-weight:800">€0.00</div>
              </div>
            </div>
            <div style="margin-top:.6rem"><button id="btnSignOut" class="btn secondary">Sign out</button></div>
          </div>
        </nav>

        <main id="appContent">
          <!-- dashboard / pages will be injected in later chunks -->
          <div class="onboarding">
            <h3>Welcome to DeutscheGlobal</h3>
            <p style="color:var(--muted)">Access your accounts, make payments, manage cards and loans — secure and fast.</p>
            <div style="margin-top:.6rem"><button id="btnSpeedTours" class="btn">Quick tour</button></div>
          </div>
        </main>
      </div>
    </section>

    <footer class="site-footer" role="contentinfo">
      <div class="container foot-grid">
        <div>© <strong>DeutscheGlobal Bank</strong> — All rights reserved.</div>
        <div style="color:var(--muted)"><a href="#privacy" style="color:var(--muted);">Privacy</a> · <a href="#security" style="color:var(--muted);">Security</a> · <a href="#contact" style="color:var(--muted);">Contact</a></div>
      </div>
    </footer>
  </main>

  <!-- AUTH MODAL (Sign in / Register / Forgot) -->
  <div id="authModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="authHeading">
    <div class="modal" role="document" aria-live="assertive">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="authHeading">Sign in to your account</h3>
        <button id="closeAuth" class="btn secondary" aria-label="Close sign in modal">Close</button>
      </div>

      <div style="margin-top:.8rem;">
        <div id="authForms">
          <!-- Sign in -->
          <form id="formSignIn" style="display:block">
            <label class="skip" for="si_email">Email</label>
            <input id="si_email" class="input" type="email" placeholder="name@company.com" required autocomplete="username" />
            <label class="skip" for="si_password">Password</label>
            <input id="si_password" class="input" type="password" placeholder="Password" required autocomplete="current-password" />
            <div style="display:flex;gap:.6rem;margin-top:.6rem;align-items:center;justify-content:space-between">
              <button type="submit" class="btn">Sign in</button>
              <div style="display:flex;gap:.4rem">
                <button type="button" id="openRegister" class="btn secondary">Open account</button>
                <button type="button" id="openForgot" class="btn secondary">Forgot</button>
              </div>
            </div>
          </form>

          <!-- Register -->
          <form id="formRegister" style="display:none;margin-top:.6rem">
            <label class="skip" for="r_first">First name</label>
            <input id="r_first" class="input" placeholder="First name" required />
            <label class="skip" for="r_last">Last name</label>
            <input id="r_last" class="input" placeholder="Last name" required style="margin-top:.45rem" />
            <label class="skip" for="r_email">Email</label>
            <input id="r_email" class="input" type="email" placeholder="Email" required style="margin-top:.45rem" />
            <label class="skip" for="r_password">Password</label>
            <input id="r_password" class="input" type="password" placeholder="Create password (8+ characters)" required style="margin-top:.45rem" />
            <div style="display:flex;gap:.5rem;margin-top:.6rem;justify-content:flex-end">
              <button id="submitRegister" class="btn">Create account</button>
              <button id="backToSignIn" type="button" class="btn secondary">Back</button>
            </div>
          </form>

          <!-- Forgot password -->
          <form id="formForgot" style="display:none;margin-top:.6rem">
            <label class="skip" for="f_email">Email</label>
            <input id="f_email" class="input" type="email" placeholder="Enter your account email" required />
            <div style="display:flex;gap:.6rem;margin-top:.6rem;justify-content:flex-end">
              <button id="doForgot" class="btn">Send reset link</button>
              <button id="backToSignIn2" type="button" class="btn secondary">Back</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- basic toast host -->
  <div id="toastHost" aria-live="polite" style="position:fixed;right:1rem;bottom:1rem;z-index:1000"></div>

  <script>
    /*
      CHUNK 1 JS (Upgraded):
      - Added dark mode toggle and persistence.
      - Integrated EmailJS for auth emails (welcome, reset).
      - Fixed landing id and display toggles.
      - Added modal show animations.
      - Improved seeding and security notes.
    */

    // Utilities
    const uid = (n=8) => { const chars='abcdefghijklmnopqrstuvwxyz0123456789'; let s=''; for(let i=0;i<n;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; };
    const nowISO = () => new Date().toISOString();
    function showToast(msg, type='info', t=3000){
      const host = document.getElementById('toastHost');
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      el.style.padding = '.65rem .9rem';
      el.style.borderRadius = '10px';
      el.style.background = type==='success' ? '#10b981' : type==='error' ? '#ef4444' : 'var(--primary)';
      el.style.color = '#fff';
      el.style.marginTop = '.5rem';
      host.appendChild(el);
      setTimeout(()=>el.remove(), t);
    }

    // SHA-256 helper for client-side hashing
    async function sha256(hexInput) {
      const enc = new TextEncoder();
      const data = enc.encode(hexInput);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // Minimal IndexedDB wrapper
    const DB = (function(){
      const DBNAME = 'DGBank_Prod_v1', DBVER = 1;
      let db = null;
      function open(){
        return new Promise((resolve,reject)=>{
          if(db) return resolve(db);
          const r = indexedDB.open(DBNAME, DBVER);
          r.onupgradeneeded = (ev) => {
            const idb = ev.target.result;
            if(!idb.objectStoreNames.contains('users')){
              const s = idb.createObjectStore('users', { keyPath: 'id' });
              s.createIndex('email', 'email', { unique: true });
            }
            if(!idb.objectStoreNames.contains('accounts')){
              const s = idb.createObjectStore('accounts', { keyPath: 'id' });
              s.createIndex('userId','userId', { unique: false });
              s.createIndex('accountNumber','accountNumber', { unique: true });
            }
            if(!idb.objectStoreNames.contains('transactions')){
              idb.createObjectStore('transactions', { keyPath: 'id' });
            }
            if(!idb.objectStoreNames.contains('audit')){
              idb.createObjectStore('audit', { keyPath: 'id' });
            }
          };
          r.onsuccess = (e) => { db = e.target.result; resolve(db); };
          r.onerror = (e) => { console.error('DB open err',e); reject(e); };
        });
      }
      async function tx(storeNames, mode='readonly'){
        const d = await open();
        const t = d.transaction(storeNames, mode);
        const stores = {};
        for(const s of storeNames) stores[s] = t.objectStore(s);
        return { t, stores, complete: new Promise((res,rej)=>{ t.oncomplete=()=>res(); t.onerror=e=>rej(e); t.onabort=e=>rej(e); })};
      }
      return {
        add: async (store, obj) => {
          try{
            const { stores } = await tx([store], 'readwrite');
            return new Promise((res,rej)=>{ const r = stores[store].add(obj); r.onsuccess = ()=>res(obj); r.onerror=e=>rej(e); });
          }catch(e){
            // fallback to localStorage for resilience (not recommended for prod)
            const arr = JSON.parse(localStorage.getItem(store)||'[]'); arr.push(obj); localStorage.setItem(store, JSON.stringify(arr)); return obj;
          }
        },
        put: async (store, obj) => {
          const { stores } = await tx([store],'readwrite');
          return new Promise((res,rej)=>{ const r = stores[store].put(obj); r.onsuccess = ()=>res(obj); r.onerror=e=>rej(e); });
        },
        get: async (store, key) => {
          const { stores } = await tx([store], 'readonly');
          return new Promise((res,rej)=>{ const r = stores[store].get(key); r.onsuccess = ()=>res(r.result); r.onerror = e=>rej(e); });
        },
        getAll: async (store) => {
          try{
            const { stores } = await tx([store], 'readonly');
            return new Promise((res,rej)=>{ const r = stores[store].getAll(); r.onsuccess = ()=>res(r.result||[]); r.onerror=e=>rej(e); });
          }catch(e){
            return JSON.parse(localStorage.getItem(store)||'[]');
          }
        },
        delete: async (store, key) => {
          const { stores } = await tx([store], 'readwrite');
          return new Promise((res,rej)=>{ const r=stores[store].delete(key); r.onsuccess=()=>res(); r.onerror=e=>rej(e); });
        },
        clear: async (store) => {
          const { stores } = await tx([store], 'readwrite');
          return new Promise((res,rej)=>{ const r=stores[store].clear(); r.onsuccess=()=>res(); r.onerror=e=>rej(e); });
        }
      };
    })();

    /* Seed professional initial data if none exists.
       NOTE: For production this seeding would not be present.
       Since you requested a professional feel, seed uses realistic names and images,
       but these entries are initial test data to let the app run end-to-end.
    */
    async function seedIfEmpty(){
      try{
        const users = await DB.getAll('users');
        if(users.length>0) return;
        // create a superadmin (hidden access)
        const adminPassHash = await sha256('admin/admin111'); // upgraded default for demo
        await DB.add('users', { id: 'u_superadmin', email: 'admin@deutscheglobal.bank', password: adminPassHash, firstName: 'System', lastName: 'Administrator', role: 'superadmin', createdAt: nowISO(), status: 'active' });
        // create sample professional users
        const people = [
          { first:'Lukas', last:'Müller', email:'lukas.mueller@company.de' },
          { first:'Anna', last:'Schmidt', email:'anna.schmidt@company.de' },
          { first:'Max', last:'Becker', email:'max.becker@business.de' },
          { first:'Sophie', last:'Fischer', email:'sophie.fischer@firm.de' }
        ];
        const defaultPassHash = await sha256('Welcome!2025');
        for(const p of people){
          const id = 'u_'+uid(8);
          await DB.add('users', { id, email: p.email, password: defaultPassHash, firstName: p.first, lastName: p.last, role: 'user', createdAt: nowISO(), status:'active' });
          // create a checking account
          const acc = { id: 'a_'+uid(9), userId: id, accountNumber: 'DE' + Math.floor(10000000 + Math.random()*89999999), accountType: 'checking', balance: Math.round((Math.random()*9000+1000)*100)/100, currency: 'EUR', status:'active', createdAt: nowISO() };
          await DB.add('accounts', acc);
        }
        showToast('Welcome to DeutscheGlobal — your account experience is ready', 'success', 4000);
      }catch(e){ console.error('Seed error', e); }
    }

    /* Auth - register & sign in logic */
    async function registerUser({ firstName, lastName, email, passwordPlain }){
      if(!email || !passwordPlain) throw new Error('Email and password are required');
      const emailLower = email.toLowerCase();
      const all = await DB.getAll('users');
      if(all.find(u=>u.email && u.email.toLowerCase()===emailLower)) throw new Error('An account with this email already exists');
      const id = 'u_'+uid(8);
      const hashed = await sha256(passwordPlain);
      const user = { id, email: emailLower, password: hashed, firstName, lastName, role: 'user', status: 'active', createdAt: nowISO() };
      await DB.add('users', user);
      // Create a primary checking account
      const account = { id: 'a_'+uid(9), userId: id, accountNumber: 'DE'+Math.floor(10000000 + Math.random()*89999999), accountType: 'checking', balance: 0.00, currency: 'EUR', status: 'active', createdAt: nowISO() };
      await DB.add('accounts', account);
      // Send welcome email if configured
      const cfg = JSON.parse(localStorage.getItem('dgb_email_cfg')||'{}');
      if(cfg.service_id && cfg.template_id && cfg.public_key){
        try{
          await emailjs.send(cfg.service_id, cfg.template_id, {
            to_email: email,
            subject: 'Welcome to DeutscheGlobal Bank',
            message: 'Your account has been created successfully. Sign in to get started.',
            from_name: 'DeutscheGlobal'
          });
        }catch(e){ console.warn('Welcome email failed', e); }
      }
      return user;
    }

    async function signIn(email, passwordPlain){
      const users = await DB.getAll('users');
      const hashed = await sha256(passwordPlain);
      const user = users.find(u => u.email && u.email.toLowerCase() === email.toLowerCase() && u.password === hashed);
      if(!user) throw new Error('Invalid credentials');
      // persist session minimally
      localStorage.setItem('dgb_session', JSON.stringify({ userId: user.id, ts: Date.now() }));
      return user;
    }

    async function signOut(){
      localStorage.removeItem('dgb_session');
      // reload to show landing; more graceful UI updates in next chunks
      location.reload();
    }

    /* UI wiring: auth modal show/hide and submit handlers */
    (function wireAuthUI(){
      const authModal = document.getElementById('authModal');
      const openSignIn = document.getElementById('openSignIn');
      const ctaRegister = document.getElementById('ctaOpenRegister');
      const closeAuth = document.getElementById('closeAuth');
      const btnOpenRegister = document.getElementById('openRegister');
      const btnBackToSign = document.getElementById('backToSignIn');
      const btnBackToSign2 = document.getElementById('backToSignIn2');
      const openForgot = document.getElementById('openForgot');
      const openContact = document.getElementById('openContact');

      openSignIn.addEventListener('click', ()=>{ openAuth('signin'); });
      ctaRegister.addEventListener('click', ()=>{ openAuth('register'); });
      btnOpenRegister.addEventListener('click', ()=>{ openAuth('register'); });
      closeAuth.addEventListener('click', ()=> { authModal.classList.remove('show'); setTimeout(()=>{ authModal.style.display = 'none'; }, 300); });
      if(openForgot) openForgot.addEventListener('click', ()=> openAuth('forgot'));
      if(openContact) openContact.addEventListener('click', openChat); // Upgraded to open chat modal

      function openAuth(mode='signin'){
        authModal.style.display = 'flex';
        setTimeout(()=>{ authModal.classList.add('show'); }, 10);
        const formSign = document.getElementById('formSignIn');
        const formReg = document.getElementById('formRegister');
        const formForgot = document.getElementById('formForgot');
        formSign.style.display = mode==='signin' ? 'block' : 'none';
        formReg.style.display = mode==='register' ? 'block' : 'none';
        formForgot.style.display = mode==='forgot' ? 'block' : 'none';
        // focus
        setTimeout(()=>{ if(mode==='signin') document.getElementById('si_email').focus(); if(mode==='register') document.getElementById('r_first').focus(); }, 120);
      }

      // Sign in submit
      document.getElementById('formSignIn').addEventListener('submit', async function(e){
        e.preventDefault();
        const email = document.getElementById('si_email').value.trim();
        const pw = document.getElementById('si_password').value.trim();
        if(!email || !pw){ showToast('Please provide email and password', 'error'); return; }
        try{
          const user = await signIn(email, pw);
          // basic UI transition; full dashboard will be rendered in chunk 2
          document.getElementById('landing').style.display = 'none';
          document.getElementById('appShell').style.display = 'block';
          document.getElementById('appContent').innerHTML = `<div style="padding:1rem"><h3>Welcome, ${user.firstName} ${user.lastName}</h3><p style="color:var(--muted)">Loading your workspace…</p></div>`;
          authModal.classList.remove('show');
          setTimeout(()=>{ authModal.style.display = 'none'; }, 300);
          showToast('Signed in', 'success');
          // in next chunks we'll populate dashboard; for now, set preview
          document.getElementById('uNamePreview').textContent = `${user.firstName} ${user.lastName}`;
          document.getElementById('uMailPreview').textContent = user.email;
          // trigger dashboard refresh (next chunk)
        }catch(err){
          showToast(err.message || 'Sign in failed', 'error');
        }
      });

      // Register submit
      document.getElementById('formRegister').addEventListener('submit', async function(e){
        e.preventDefault();
        const first = document.getElementById('r_first').value.trim();
        const last = document.getElementById('r_last').value.trim();
        const email = document.getElementById('r_email').value.trim();
        const pw = document.getElementById('r_password').value.trim();
        if(!first || !last || !email || pw.length < 8){ showToast('Complete all fields. Password must be at least 8 characters.', 'error'); return; }
        try{
          const user = await registerUser({ firstName: first, lastName: last, email, passwordPlain: pw });
          showToast('Your account has been created — please sign in', 'success');
          // Move back to sign in automatically
          openAuth('signin');
        }catch(err){
          showToast(err.message || 'Registration failed', 'error');
        }
      });

      // Forgot password (integrated with EmailJS)
      document.getElementById('formForgot').addEventListener('submit', async function(e){
        e.preventDefault();
        const email = document.getElementById('f_email').value.trim();
        if(!email){ showToast('Please enter your email', 'error'); return; }
        const cfg = JSON.parse(localStorage.getItem('dgb_email_cfg')||'{}');
        const users = await DB.getAll('users');
        if(users.find(u=>u.email.toLowerCase() === email.toLowerCase())){
          if(cfg.service_id && cfg.template_id && cfg.public_key){
            try{
              await emailjs.send(cfg.service_id, cfg.template_id, {
                to_email: email,
                subject: 'DeutscheGlobal Password Reset',
                message: 'Click this link to reset your password: [secure link placeholder for production]',
                from_name: 'DeutscheGlobal'
              });
              showToast('Reset instructions sent to your email', 'success');
            }catch(err){
              showToast('Failed to send reset email. Please contact support.', 'error');
            }
          } else {
            showToast('Email service not configured. Contact admin.', 'info');
          }
        } else {
          showToast('If an account exists with this email, reset instructions have been sent.', 'info');
        }
        document.getElementById('formForgot').reset();
        openAuth('signin');
      });

      // back buttons
      btnBackToSign.addEventListener('click', ()=> openAuth('signin'));
      btnBackToSign2.addEventListener('click', ()=> openAuth('signin'));
    })();

    // Logo triple-click => open admin (hidden access)
    (function wireAdminSecret(){
      const logo = document.getElementById('siteLogo');
      let clicks = 0, timer = null;
      logo.addEventListener('click', async () => {
        clicks++;
        clearTimeout(timer);
        timer = setTimeout(()=> clicks = 0, 1200);
        if(clicks >= 3){
          clicks = 0;
          const pwd = prompt('Super Admin access — enter password:');
          if(pwd === 'admin/admin111'){
            // show admin modal (admin UI will be in chunk 3)
            showToast('Admin access granted — launching console', 'success');
            openAdmin();
          } else {
            showToast('Invalid admin password', 'error');
          }
        }
      });
      // accessibility: allow Enter/Space to trigger
      logo.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); logo.click(); } });
    })();

    // Initialize DB seed & restore session if present
    (async function init(){
      // EmailJS init if configured
      const cfg = JSON.parse(localStorage.getItem('dgb_email_cfg')||'{}');
      if(cfg.public_key) emailjs.init(cfg.public_key);
      // Dark mode
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      document.getElementById('themeToggle').addEventListener('click', () => {
        const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      });
      await seedIfEmpty();
      try{
        const s = JSON.parse(localStorage.getItem('dgb_session') || 'null');
        if(s && s.userId){
          // fetch user and automatically show app shell preview (full dashboard in chunk 2)
          const users = await DB.getAll('users'); const u = users.find(x=>x.id === s.userId);
          if(u){
            document.getElementById('landing').style.display = 'none';
            document.getElementById('appShell').style.display = 'block';
            document.getElementById('uNamePreview').textContent = `${u.firstName} ${u.lastName}`;
            document.getElementById('uMailPreview').textContent = u.email;
          }
        }
      }catch(e){ console.warn('Session restore failed', e); }
    })();
  </script>
<!-- CHUNK 2 START -->
<script>
/*
  CHUNK 2 (Upgraded)
  Dashboard, Accounts, Transfers, Transactions, Receipts, UI wiring
  - Added chat modal for support/contact.
  - Improved render functions with better layouts.
  - Added mock stock updates.
*/

window.App = window.App || { user: null, stocks: {}, fx: { EUR:1, USD:1.09, GBP:0.86 }, symbols: ['DAX','DBX','BMW','SAP','BAYN'] };

/* Ensure PushMock exists for notifications */
window.PushMock = window.PushMock || { clients: [], connect(cb){ const id='c_'+Math.random().toString(36).slice(2,8); this.clients.push({id,cb}); return ()=>{ this.clients=this.clients.filter(x=>x.id!==id); } }, send(msg){ this.clients.forEach(c=>c.cb(msg)); } };

/* Utility to create and/or return modal DOM */
function ensureModal(id, htmlContent) {
  let modal = document.getElementById(id);
  if(modal) return modal;
  const wrapper = document.createElement('div');
  wrapper.id = id;
  wrapper.className = 'modal-backdrop';
  wrapper.style.display = 'none';
  wrapper.innerHTML = `<div class="modal" role="dialog" aria-modal="true">${htmlContent}</div>`;
  document.body.appendChild(wrapper);
  // dismiss on backdrop click
  wrapper.addEventListener('click', (e)=>{ if(e.target===wrapper) { wrapper.classList.remove('show'); setTimeout(()=>{ wrapper.style.display = 'none'; }, 300); } });
  // accessibility trap basic: ESC to close
  wrapper.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { wrapper.classList.remove('show'); setTimeout(()=>{ wrapper.style.display = 'none'; }, 300); } });
  return wrapper;
}

/* Create Transfer Modal */
ensureModal('transferModal', `
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>Initiate Transfer</h3>
    <button class="btn secondary" id="closeTransferModal">Close</button>
  </div>
  <form id="transferForm" style="margin-top:.8rem">
    <label class="skip" for="tr_from">From account</label>
    <select id="tr_from" class="input" aria-label="From account"></select>

    <label class="skip" for="tr_to">To (IBAN or account)</label>
    <input id="tr_to" class="input" aria-label="To account" placeholder="Recipient account number / IBAN" />

    <div style="display:flex;gap:.5rem;margin-top:.6rem">
      <input id="tr_amount" class="input" type="number" step="0.01" min="0.01" placeholder="Amount" aria-label="Amount" />
      <select id="tr_currency" class="input" style="max-width:120px" aria-label="Currency">
        <option>EUR</option><option>USD</option><option>GBP</option>
      </select>
    </div>

    <input id="tr_desc" class="input" placeholder="Description (optional)" style="margin-top:.6rem" aria-label="Description" />
    <div style="text-align:right;margin-top:.6rem">
      <button class="btn" id="tr_submit">Confirm & Submit</button>
    </div>
  </form>
`);

/* Create Feedback Modal (transaction initiated) */
ensureModal('feedbackModal', `
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3 id="fb_title">Transaction initiated</h3>
    <button class="btn secondary" id="closeFeedbackModal">Close</button>
  </div>
  <div id="fb_body" style="margin-top:.6rem;color:var(--muted)"></div>
  <div style="text-align:right;margin-top:.6rem"><button class="btn" id="fb_ok">Done</button></div>
`);

/* Create Chat Modal (new feature for support) */
ensureModal('chatModal', `
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>Support Chat</h3>
    <button class="btn secondary" id="closeChatModal">Close</button>
  </div>
  <div id="chatBody" style="height:200px;overflow:auto;background:var(--glass-2);padding:.5rem;border-radius:8px;border:1px solid var(--glass-border);margin-top:.6rem"></div>
  <input id="chatInput" class="input" placeholder="Type your message..." style="margin-top:.5rem" />
  <div style="text-align:right;margin-top:.6rem"><button id="chatSend" class="btn">Send</button></div>
`);

/* Wire modals with animations */
function openModal(id){
  const modal = document.getElementById(id);
  modal.style.display = 'flex';
  setTimeout(()=>{ modal.classList.add('show'); }, 10);
}

/* Wire transfer modal controls */
document.getElementById('closeTransferModal').addEventListener('click', ()=> { const m = document.getElementById('transferModal'); m.classList.remove('show'); setTimeout(()=>{ m.style.display='none'; }, 300); });
document.getElementById('closeFeedbackModal').addEventListener('click', ()=> { const m = document.getElementById('feedbackModal'); m.classList.remove('show'); setTimeout(()=>{ m.style.display='none'; }, 300); });
document.getElementById('fb_ok').addEventListener('click', ()=> { const m = document.getElementById('feedbackModal'); m.classList.remove('show'); setTimeout(()=>{ m.style.display='none'; }, 300); });

/* Wire chat modal */
document.getElementById('closeChatModal').addEventListener('click', ()=> { const m = document.getElementById('chatModal'); m.classList.remove('show'); setTimeout(()=>{ m.style.display='none'; }, 300); });
document.getElementById('chatSend').addEventListener('click', ()=>{
  const input = document.getElementById('chatInput');
  const body = document.getElementById('chatBody');
  const msg = input.value.trim();
  if(!msg) return;
  body.innerHTML += `<div style="margin-bottom:.5rem"><strong>You:</strong> ${msg}</div>`;
  input.value = '';
  body.scrollTop = body.scrollHeight;
  setTimeout(()=>{
    body.innerHTML += `<div style="margin-bottom:.5rem"><strong>Support:</strong> Thank you for your message. Our team will respond shortly.</div>`;
    body.scrollTop = body.scrollHeight;
  }, 1500);
});
window.openChat = ()=>{ openModal('chatModal'); };

/* Receipt generation using jsPDF (already loaded in head) */
async function generateReceiptPDF(tx) {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    doc.setFontSize(18); doc.text('DeutscheGlobal Bank', 40, 60);
    doc.setFontSize(12); doc.text('Transaction Receipt', 40, 90);
    doc.setFontSize(10);
    const lines = [
      ['Transaction ID', tx.id],
      ['Date', tx.processedAt || tx.createdAt],
      ['From', tx.fromAccountId],
      ['To', tx.toAccountId],
      ['Amount', `${tx.amount} ${tx.currency}`],
      ['Type', tx.type],
      ['Status', tx.status]
    ];
    let y = 120;
    lines.forEach(l=>{
      doc.text(`${l[0]}: ${String(l[1])}`, 40, y);
      y += 18;
    });
    if(tx.adminNotes) { doc.text(`Admin notes: ${tx.adminNotes}`, 40, y); y+=18; }
    doc.setFontSize(9); doc.text('This document is issued by DeutscheGlobal Bank', 40, y+20);
    doc.save(`receipt_${tx.id}.pdf`);
  } catch (e) {
    console.error('Receipt PDF error', e);
    showToast('Unable to generate receipt', 'error');
  }
}

/* Helper: get current user's accounts and fill select */
async function populateFromAccountsSelect(selectId='tr_from') {
  const select = document.getElementById(selectId);
  if(!select) return;
  select.innerHTML = '';
  if(!App.user) {
    const s = JSON.parse(localStorage.getItem('dgb_session')||'null'); if(s && s.userId) { const users = await DB.getAll('users'); App.user = users.find(u=>u.id===s.userId) || null; }
  }
  const accounts = App.user ? (await DB.getAll('accounts')).filter(a=>a.userId===App.user.id) : [];
  if(accounts.length===0) { const opt = document.createElement('option'); opt.value=''; opt.textContent='No accounts'; select.appendChild(opt); return; }
  for(const a of accounts){
    const o = document.createElement('option'); o.value = a.id; o.textContent = `${a.accountNumber} • ${new Intl.NumberFormat('de-DE',{style:'currency',currency:a.currency}).format(a.balance)}`;
    select.appendChild(o);
  }
}

/* Create transaction object & store as pending */
async function createPendingTransaction({ fromAccountId, toAccountId, amount, currency='EUR', description='' }){
  const tx = {
    id: 't_'+uid(10),
    fromAccountId, toAccountId,
    amount: Math.round(Number(amount)*100)/100,
    currency, type: 'transfer', status: 'pending',
    description: description || '', createdAt: nowISO(), processedAt: null, adminNotes: ''
  };
  await DB.add('transactions', tx);
  // create audit
  await DB.add('audit', { id: 'al_'+uid(8), action: 'createTransaction', data: tx, createdAt: nowISO() });
  // push notify
  PushMock.send({ title: 'Transaction initiated', body: `Transaction ${tx.id} is pending admin approval.` });
  return tx;
}

/* Transfer form submit */
document.getElementById('tr_submit').addEventListener('click', async function(e){
  e.preventDefault();
  const from = document.getElementById('tr_from').value;
  const to = document.getElementById('tr_to').value.trim();
  const amount = parseFloat(document.getElementById('tr_amount').value || 0);
  const currency = document.getElementById('tr_currency').value;
  const desc = document.getElementById('tr_desc').value || '';
  if(!from || !to || !amount || amount <= 0) { showToast('Please complete transfer details', 'error'); return; }
  // Basic business rule: cannot transfer negative amount
  try {
    const tx = await createPendingTransaction({ fromAccountId: from, toAccountId: to, amount, currency, description: desc });
    // Show feedback modal
    document.getElementById('fb_title').textContent = 'Transfer initiated';
    document.getElementById('fb_body').textContent = `Your transfer (${new Intl.NumberFormat('de-DE',{style:'currency',currency}).format(amount)}) has been queued and is pending approval. You will be notified when processed. Reference: ${tx.id}`;
    openModal('feedbackModal');
    // close transfer modal
    const tm = document.getElementById('transferModal'); tm.classList.remove('show'); setTimeout(()=>{ tm.style.display='none'; }, 300);
    // refresh UI
    await renderTransactions(); await renderAccounts();
  } catch (err) {
    console.error('Transfer create error', err);
    showToast(err.message || 'Transfer failed', 'error');
  }
});

/* Render functions for dashboard pages */
async function renderDashboardOverview() {
  const main = document.getElementById('appContent');
  main.innerHTML = '';
  if(!App.user){
    main.innerHTML = `<div class="onboarding"><h3>Welcome</h3><p style="color:var(--muted)">Sign in to access your accounts and services.</p></div>`;
    return;
  }
  const accounts = (await DB.getAll('accounts')).filter(a=>a.userId===App.user.id);
  const total = accounts.reduce((s,a)=>s+a.balance,0);
  const wrapper = document.createElement('div');
  wrapper.className = 'onboarding';
  wrapper.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><h3>Good day, ${App.user.firstName}</h3><div style="color:var(--muted)">${App.user.email}</div></div>
    <div style="text-align:right"><div style="color:var(--muted);font-size:.85rem">Total balance</div><div style="font-weight:800">${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(total)}</div></div>
  </div>`;
  // account cards
  const cardsWrap = document.createElement('div'); cardsWrap.style.display='grid'; cardsWrap.style.gridTemplateColumns='repeat(auto-fit, minmax(200px, 1fr))'; cardsWrap.style.gap='8px'; cardsWrap.style.marginTop='12px';
  for(const a of accounts){
    const c = document.createElement('div'); c.className='account-card service'; // reuse service style for hover
    c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:800">${a.accountType.toUpperCase()}</div>
        <div style="color:var(--muted);font-size:.88rem">${a.accountNumber}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:800">${new Intl.NumberFormat('de-DE',{style:'currency',currency:a.currency}).format(a.balance)}</div>
        <div style="margin-top:.5rem"><button class="btn ghost" onclick="openTransferForAccount('${a.id}')">Send</button></div>
      </div>
    </div>`;
    cardsWrap.appendChild(c);
  }
  wrapper.appendChild(cardsWrap);

  // recent transactions
  const allTx = await DB.getAll('transactions');
  const myIds = accounts.map(a=>a.id);
  const myTx = allTx.filter(t=> myIds.includes(t.fromAccountId) || myIds.includes(t.toAccountId)).sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt)).slice(0,8);
  const txCard = document.createElement('div'); txCard.className='onboarding'; txCard.style.marginTop='1rem';
  txCard.innerHTML = `<h4>Recent activity</h4>`;
  const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
  table.innerHTML = `<thead><tr><th>Date</th><th>From</th><th>Amount</th><th>Status</th></tr></thead>`;
  const tb = document.createElement('tbody');
  myTx.forEach(t=>{
    const tr = document.createElement('tr'); tr.style.borderBottom = '1px solid var(--glass-border)';
    tr.innerHTML = `<td>${new Date(t.createdAt).toLocaleString()}</td><td style="max-width:120px;overflow:hidden;text-overflow:ellipsis">${t.fromAccountId}</td><td>${new Intl.NumberFormat('de-DE',{style:'currency',currency:t.currency}).format(t.amount)}</td><td>${t.status}</td>`;
    tb.appendChild(tr);
  });
  table.appendChild(tb); txCard.appendChild(table);
  wrapper.appendChild(txCard);

  main.appendChild(wrapper);
}

/* open transfer modal with prefilled from account */
async function openTransferForAccount(accountId){
  await populateFromAccountsSelect('tr_from');
  if(accountId) document.getElementById('tr_from').value = accountId;
  document.getElementById('tr_to').value = '';
  document.getElementById('tr_amount').value = '';
  document.getElementById('tr_desc').value = '';
  openModal('transferModal');
  document.getElementById('tr_to').focus();
}

/* Render accounts page (detailed) */
async function renderAccounts() {
  const main = document.getElementById('appContent');
  main.innerHTML = '';
  const accounts = (await DB.getAll('accounts')).filter(a=>a.userId===App.user.id);
  const wrapper = document.createElement('div'); wrapper.className='onboarding';
  wrapper.innerHTML = `<h3>Accounts</h3><p style="color:var(--muted)">Manage your accounts, view IBAN and balances.</p>`;
  const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
  table.innerHTML = `<thead><tr><th>Type</th><th>Number</th><th>Balance</th><th>Actions</th></tr></thead>`;
  const tb = document.createElement('tbody');
  for(const a of accounts){
    const tr = document.createElement('tr'); tr.style.borderBottom = '1px solid var(--glass-border)';
    tr.innerHTML = `<td>${a.accountType}</td><td>${a.accountNumber}</td><td>${new Intl.NumberFormat('de-DE',{style:'currency',currency:a.currency}).format(a.balance)}</td><td><button class="btn ghost" onclick="openTransferForAccount('${a.id}')">Send</button> <button class="btn" onclick="downloadStatement('${a.id}')">Statement</button></td>`;
    tb.appendChild(tr);
  }
  table.appendChild(tb); wrapper.appendChild(table);
  main.appendChild(wrapper);
}

/* generate a simple statement PDF for account */
async function downloadStatement(accountId) {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const account = (await DB.getAll('accounts')).find(a=>a.id===accountId);
    if(!account){ showToast('Account not found', 'error'); return; }
    doc.setFontSize(16); doc.text('Account Statement', 40, 60);
    doc.setFontSize(11); doc.text(`Account: ${account.accountNumber}`, 40, 80);
    const txs = (await DB.getAll('transactions')).filter(t=> t.fromAccountId===accountId || t.toAccountId===accountId ).slice(0,100);
    doc.setFontSize(10);
    let y = 100;
    txs.forEach(t=>{
      doc.text(`${new Date(t.createdAt).toLocaleDateString()} ${t.id} ${t.amount} ${t.currency} ${t.status}`, 40, y);
      y += 12;
      if(y > 760){ doc.addPage(); y = 40; }
    });
    doc.save(`statement_${account.accountNumber}.pdf`);
  } catch(e) { console.error(e); showToast('Unable to create statement', 'error'); }
}

/* Render transactions page (all relevant) */
async function renderTransactions() {
  const main = document.getElementById('appContent');
  main.innerHTML = '';
  const accounts = (await DB.getAll('accounts')).filter(a=>a.userId===App.user.id);
  const myIds = accounts.map(a=>a.id);
  const txs = (await DB.getAll('transactions')).filter(t=> myIds.includes(t.fromAccountId) || myIds.includes(t.toAccountId)).sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
  const wrapper = document.createElement('div'); wrapper.className='onboarding';
  wrapper.innerHTML = `<h3>Transactions</h3><p style="color:var(--muted)">Complete history of your transfers and payments</p>`;
  const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
  table.innerHTML = `<thead><tr><th>ID</th><th>Date</th><th>From</th><th>To</th><th>Amount</th><th>Status</th><th>Receipt</th></tr></thead>`;
  const tb = document.createElement('tbody');
  txs.forEach(t=>{
    const tr = document.createElement('tr'); tr.style.borderBottom = '1px solid var(--glass-border)';
    const receiptBtn = t.status === 'completed' ? `<button class="btn ghost" onclick='(async ()=>{ await generateReceiptPDF(${JSON.stringify(t).replace(/"/g,"&quot;")}); })()'>PDF</button>` : '-';
    tr.innerHTML = `<td>${t.id}</td><td>${new Date(t.createdAt).toLocaleString()}</td><td style="max-width:120px;overflow:hidden">${t.fromAccountId}</td><td style="max-width:120px;overflow:hidden">${t.toAccountId}</td><td>${new Intl.NumberFormat('de-DE',{style:'currency',currency:t.currency}).format(t.amount)}</td><td>${t.status}</td><td>${receiptBtn}</td>`;
    tb.appendChild(tr);
  });
  table.appendChild(tb); wrapper.appendChild(table);
  main.appendChild(wrapper);
}

/* Render investments (simple mock with updates) */
async function renderInvestments() {
  const main = document.getElementById('appContent'); main.innerHTML = '';
  const wrapper = document.createElement('div'); wrapper.className = 'onboarding';
  wrapper.innerHTML = `<h3>Investments</h3><p style="color:var(--muted)">Your portfolio and mock trading tools</p>`;
  const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit, minmax(140px, 1fr))'; grid.style.gap='8px';
  App.symbols.forEach(s=>{
    const c = document.createElement('div'); c.className='service'; // hover effect
    const price = (App.stocks[s] && App.stocks[s].price) ? App.stocks[s].price : Math.round((20 + Math.random()*200)*100)/100;
    c.innerHTML = `<div style="font-weight:700">${s}</div><div style="color:var(--muted);margin-top:.35rem">${price.toFixed(2)} EUR</div><div style="margin-top:.6rem"><button class="btn ghost" onclick="buyMock('${s}')">Buy 1</button></div>`;
    grid.appendChild(c);
  });
  wrapper.appendChild(grid);
  main.appendChild(wrapper);
}

/* Render loans */
async function renderLoans() {
  const main = document.getElementById('appContent'); main.innerHTML = '';
  const wrapper = document.createElement('div'); wrapper.className='onboarding';
  wrapper.innerHTML = `<h3>Loans</h3><p style="color:var(--muted)">Apply for personal or business credit. View repayment calculators and loan status.</p>
    <div style="margin-top:.6rem">
      <input id="loan_amount" class="input" placeholder="Loan amount (EUR)" />
      <input id="loan_term" class="input" placeholder="Term (months)" style="margin-top:.5rem" />
      <div style="text-align:right;margin-top:.6rem"><button class="btn" id="loan_calc_btn">Calculate</button></div>
      <div id="loan_result" style="margin-top:.6rem;color:var(--muted)"></div>
    </div>`;
  main.appendChild(wrapper);
  document.getElementById('loan_calc_btn').addEventListener('click', ()=>{
    const P = parseFloat(document.getElementById('loan_amount').value||0);
    const n = parseInt(document.getElementById('loan_term').value||12,10);
    if(!P || P<=0) return showToast('Enter loan amount', 'error');
    const r = 0.05/12;
    const monthly = (P*r)/(1-Math.pow(1+r,-n));
    document.getElementById('loan_result').innerHTML = `Estimated monthly payment: <strong>${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(Math.round(monthly*100)/100)}</strong>`;
  });
}

/* Render support page */
async function renderSupport() {
  openChat(); // show chat modal
}

/* Buying mock */
function buyMock(sym){
  showToast(`Purchased 1 share of ${sym}`, 'success');
}

/* Hook navigation buttons (desktop shell) - app shell buttons defined in Chunk 1 */
document.getElementById('btnSpeedTours')?.addEventListener('click', async ()=>{ await renderDashboardOverview(); showToast('Welcome to your banking tour — navigate on bottom nav or the sidebar', 'info'); });
document.getElementById('btnSignOut')?.addEventListener('click', async ()=>{ await signOut(); });

/* If left-side primary nav exists (Chunk 1 reserved) wire it — fallback to bottom nav */
const sideMap = {
  'btnOverview': renderDashboardOverview,
  'btnAccounts': renderAccounts,
  'btnTransfer': openTransferForAccount,
  'btnTransactions': renderTransactions,
  'btnInvest': renderInvestments,
  'btnLoans': renderLoans,
  'btnSupport': renderSupport,
  'btnSettings': async ()=> { document.getElementById('appContent').innerHTML = '<div class="onboarding"><h3>Settings</h3><p style="color:var(--muted)">Manage language, theme and account preferences.</p></div>'; }
};
Object.keys(sideMap).forEach(id=>{
  const elBtn = document.getElementById(id);
  if(elBtn) elBtn.addEventListener('click', async ()=> { await sideMap[id](); });
});

/* Render helper for accounts & transactions used in header preview */
async function renderAccounts() { /* implemented above, keep for reference */ }

/* Render transactions on demand initially for experience */
async function initialRender() {
  // if logged in, show overview; else landing remains
  if(!App.user) {
    const s = JSON.parse(localStorage.getItem('dgb_session')||'null');
    if(s && s.userId){
      const allUsers = await DB.getAll('users');
      App.user = allUsers.find(u=>u.id===s.userId) || null;
    }
  }
  if(App.user){
    document.getElementById('landing').style.display = 'none';
    document.getElementById('appShell').style.display = 'block';
    await renderDashboardOverview();
    await populateFromAccountsSelect();
  } else {
    document.getElementById('landing').style.display = 'block';
    document.getElementById('appShell').style.display = 'none';
  }
  // Mock stock updates
  setInterval(()=>{
    App.symbols.forEach(s=> App.stocks[s] = {price: Math.round((20 + Math.random()*200)*100)/100 });
    if(document.querySelector('#appContent h3')?.textContent === 'Investments') renderInvestments();
  }, 15000);
}

/* Helper to refresh accounts view and transactions */
async function refreshViews(){
  if(document.querySelector('#appContent h3')?.textContent?.toLowerCase().includes('accounts')) { await renderAccounts(); }
  // If overview visible, update
  if(document.querySelector('#appContent h3')?.textContent?.toLowerCase().includes('welcome') || document.querySelector('#appContent h3')?.textContent?.toLowerCase().includes('good day')) { await renderDashboardOverview(); }
  if(document.querySelector('#appContent h3')?.textContent?.toLowerCase().includes('transactions')) { await renderTransactions(); }
}

/* Simulate admin processing (optional demo helper)
   This function will not auto-approve in production; it's here to demonstrate the end-to-end lifecycle.
   It will detect pending transactions and leave them pending until admin action (Chunk 3) is executed.
*/
async function demoAutoProcessPendingDemoOnly(){
  // Do not auto-approve by default. Commented out. Admin will process transactions in Chunk 3.
  // const txs = await DB.getAll('transactions'); for(const t of txs.filter(x=>x.status==='pending')){ /* process if desired */ }
}

/* Expose some helpers to global scope for later chunks */
window.renderDashboardOverview = renderDashboardOverview;
window.renderAccounts = renderAccounts;
window.renderTransfer = openTransferForAccount;
window.renderTransactions = renderTransactions;
window.renderInvestments = renderInvestments;
window.renderLoans = renderLoans;
window.generateReceiptPDF = generateReceiptPDF;

/* initialization */
(async function(){
  // ensure accounts select populated when modal opens
  document.getElementById('transferModal').addEventListener('click', ()=>{ /* trap if needed */ });
  // show initial content (if logged in)
  await initialRender();
  // subscribe to pushes for UI feedback
  PushMock.connect((m)=>{ showToast(m.title || 'Notification', 'info', 4000); });
})();
</script>
<!-- CHUNK 3 START -->
<script>
/*
  CHUNK 3 (Upgraded)
  Admin Console, CSV/JSON import/export, EmailJS integration hooks, WebSocket mock,
  Audit logs, Service Worker & manifest generators (downloadable), accessibility hardening,
  and final wiring for admin transaction approval/rejection with real-time UI updates.
  - Improved admin modal layout.
  - Added animations to admin open.
  - Enhanced export/import.
*/

/* ======= Utilities & Safety checks ======= */
if(!window.DB) throw new Error('DB not found. Ensure CHUNK 1 loaded before CHUNK 3.');
window.Admin = window.Admin || {};

/* Simple helper to create modal if not present */
function createAdminModalIfMissing(){
  if(document.getElementById('adminModal')) return;
  const div = document.createElement('div');
  div.id = 'adminModal';
  div.className = 'modal-backdrop';
  div.style.display = 'none';
  div.innerHTML = `
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle" style="max-width:980px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="adminTitle">Administration Console</h3>
        <div style="display:flex;gap:.5rem;align-items:center">
          <button id="downloadSw" class="btn ghost" title="Download sw.js">Download sw.js</button>
          <button id="downloadManifest" class="btn ghost" title="Download manifest.json">Download manifest</button>
          <button id="adminCloseBtn" class="btn">Close</button>
        </div>
      </div>

      <div style="margin-top:.8rem;display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <section style="background:var(--glass-2);padding:.8rem;border-radius:10px">
          <h4>Users</h4>
          <table class="table" id="adminUsersTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody></tbody></table>
          <div style="text-align:right;margin-top:.5rem"><button id="adminCreateUserBtn" class="btn">Create User</button></div>
        </section>

        <section style="background:var(--glass-2);padding:.8rem;border-radius:10px">
          <h4>Accounts</h4>
          <table class="table" id="adminAccountsTable"><thead><tr><th>Account</th><th>User</th><th>Balance</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </section>

        <section style="grid-column:span 2;background:var(--glass-2);padding:.8rem;border-radius:10px">
          <h4>Transactions</h4>
          <table class="table" id="adminTxTable"><thead><tr><th>ID</th><th>From</th><th>To</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </section>

        <section style="grid-column:span 2;background:var(--glass-2);padding:.8rem;border-radius:10px">
          <h4>Backup & Email</h4>
          <div style="display:flex;gap:.4rem;flex-wrap:wrap">
            <button id="adminExportJSON" class="btn ghost">Export JSON</button>
            <button id="adminExportCSV" class="btn ghost">Export CSV</button>
            <input id="adminImportFile" type="file" accept=".json,.csv" class="input" style="max-width:260px" />
            <button id="adminDoImport" class="btn">Import</button>
          </div>
          <div style="display:flex;gap:.4rem;align-items:center;margin-top:.6rem">
            <input id="email_service_admin" class="input" placeholder="EmailJS service_id" />
            <input id="email_template_admin" class="input" placeholder="EmailJS template_id" />
            <input id="email_public_admin" class="input" placeholder="EmailJS public key" />
            <button id="adminSaveEmail" class="btn">Save</button>
            <button id="adminTestEmail" class="btn ghost">Send Test</button>
          </div>
        </section>

        <section style="grid-column:span 2;background:var(--glass-2);padding:.8rem;border-radius:10px">
          <h4>Audit Logs</h4>
          <div id="auditList" style="max-height:160px;overflow:auto;background:var(--glass-2);padding:.5rem;border-radius:8px;border:1px solid var(--glass-border)"></div>
        </section>
      </div>
    </div>
  `;
  document.body.appendChild(div);

  document.getElementById('adminCloseBtn').addEventListener('click', ()=> { const m = document.getElementById('adminModal'); m.classList.remove('show'); setTimeout(()=>{ m.style.display='none'; }, 300); });
  document.getElementById('adminCreateUserBtn').addEventListener('click', adminCreateUser);
  document.getElementById('adminExportJSON').addEventListener('click', adminExportJSON);
  document.getElementById('adminExportCSV').addEventListener('click', adminExportCSV);
  document.getElementById('adminDoImport').addEventListener('click', adminImportFile);
  document.getElementById('adminSaveEmail').addEventListener('click', adminSaveEmailCfg);
  document.getElementById('adminTestEmail').addEventListener('click', adminSendTestEmail);
  document.getElementById('downloadSw').addEventListener('click', ()=> downloadFile(swCode(), 'sw.js', 'application/javascript'));
  document.getElementById('downloadManifest').addEventListener('click', ()=> downloadFile(JSON.stringify(manifestJSON(), null, 2), 'manifest.json', 'application/json'));
}

/* ======= Admin CRUD & actions ======= */

/* Render admin tables */
async function renderAdminTables(){
  try{
    const users = await DB.getAll('users');
    const accounts = await DB.getAll('accounts');
    const txs = await DB.getAll('transactions');
    // Users
    const utb = document.querySelector('#adminUsersTable tbody'); if(utb){ utb.innerHTML = ''; users.forEach(u=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${u.firstName || '-'} ${u.lastName || ''}</td><td>${u.email || '-'}</td><td>${u.role || 'user'}</td><td><button class="btn ghost" onclick="adminEditUser('${u.id}')">Edit</button> <button class="btn" onclick="adminDeleteUser('${u.id}')">Delete</button></td>`; utb.appendChild(tr); }); }
    // Accounts
    const atb = document.querySelector('#adminAccountsTable tbody'); if(atb){ atb.innerHTML=''; accounts.forEach(a=>{ const user = users.find(u=>u.id===a.userId) || {}; const tr = document.createElement('tr'); tr.innerHTML = `<td>${a.accountNumber}</td><td>${(user.firstName||'')+' '+(user.lastName||'')}</td><td>${new Intl.NumberFormat('de-DE',{style:'currency',currency:a.currency}).format(a.balance)}</td><td>${a.status}</td><td><button class="btn" onclick="adminFreezeAccount('${a.id}')">Freeze</button> <button class="btn ghost" onclick="adminCloseAccount('${a.id}')">Close</button></td>`; atb.appendChild(tr); }); }
    // Transactions
    const ttb = document.querySelector('#adminTxTable tbody'); if(ttb){ ttb.innerHTML=''; txs.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${t.id}</td><td style="max-width:120px;overflow:hidden">${t.fromAccountId}</td><td style="max-width:120px;overflow:hidden">${t.toAccountId}</td><td>${new Intl.NumberFormat('de-DE',{style:'currency',currency:t.currency}).format(t.amount)}</td><td>${t.status}</td><td><button class="btn" onclick="adminApproveTx('${t.id}')">Approve</button> <button class="btn ghost" onclick="adminRejectTx('${t.id}')">Reject</button></td>`; ttb.appendChild(tr); }); }
    renderAuditList();
  }catch(e){ console.error('renderAdminTables', e); }
}

/* Admin helpers */
async function adminCreateUser(){
  const email = prompt('Email for new user (will be created with default password Welcome!2025):');
  if(!email) return;
  const id = 'u_'+uid(8);
  const pwHash = await sha256('Welcome!2025');
  const user = { id, email: email.toLowerCase(), password: pwHash, firstName: 'New', lastName: 'User', role: 'user', createdAt: nowISO(), status:'active' };
  await DB.add('users', user);
  // create default checking account
  await DB.add('accounts', { id: 'a_'+uid(8), userId: id, accountNumber: 'DE'+Math.floor(10000000 + Math.random()*89999999), accountType:'checking', balance:0, currency:'EUR', status:'active', createdAt: nowISO()});
  await DB.add('audit', { id:'al_'+uid(8), action:'createUser', data:user, createdAt: nowISO()});
  showToast('User created', 'success');
  await renderAdminTables();
}

window.adminEditUser = async function(userId){
  const users = await DB.getAll('users'); const u = users.find(x=>x.id===userId);
  if(!u) return showToast('User not found','error');
  const name = prompt('Full name', `${u.firstName||''} ${u.lastName||''}`); if(!name) return;
  const parts = name.split(' '); u.firstName = parts[0]||u.firstName; u.lastName = parts.slice(1).join(' ')||u.lastName;
  await DB.put('users', u); await DB.add('audit', { id:'al_'+uid(8), action:'editUser', data:u, createdAt: nowISO()});
  showToast('User updated','success'); await renderAdminTables();
};

window.adminDeleteUser = async function(userId){
  if(!confirm('Delete user and associated accounts?')) return;
  const accounts = await DB.getAll('accounts'); for(const a of accounts.filter(x=>x.userId===userId)) await DB.delete('accounts', a.id);
  await DB.delete('users', userId);
  await DB.add('audit', { id:'al_'+uid(8), action:'deleteUser', data:{userId}, createdAt: nowISO()});
  showToast('User deleted','info'); await renderAdminTables();
};

window.adminFreezeAccount = async function(accountId){
  const a = await DB.get('accounts', accountId);
  if(!a) return showToast('Account not found','error');
  a.status = 'frozen'; await DB.put('accounts', a);
  await DB.add('audit', { id:'al_'+uid(8), action:'freezeAccount', data:a, createdAt: nowISO()});
  showToast('Account frozen','info'); await renderAdminTables();
};

window.adminCloseAccount = async function(accountId){
  if(!confirm('Close this account?')) return;
  const a = await DB.get('accounts', accountId);
  if(!a) return showToast('Account not found','error');
  a.status = 'closed'; await DB.put('accounts', a);
  await DB.add('audit', { id:'al_'+uid(8), action:'closeAccount', data:a, createdAt: nowISO()});
  showToast('Account closed','info'); await renderAdminTables();
};

/* Transaction approval/rejection - update balances and logs */
window.adminApproveTx = async function(txId){
  try{
    const txs = await DB.getAll('transactions'); const tx = txs.find(t=>t.id===txId);
    if(!tx) return showToast('Transaction not found','error');
    if(tx.status === 'completed') return showToast('Already processed','info');
    // validate funds
    const from = await DB.get('accounts', tx.fromAccountId);
    if(!from) { tx.status='failed'; tx.adminNotes='Origin account missing'; await DB.put('transactions', tx); await DB.add('audit',{ id:'al_'+uid(8), action:'approveTxFailed', data:tx, createdAt: nowISO()}); renderAdminTables(); showToast('Origin account missing','error'); return; }
    if(from.balance < tx.amount){ tx.status='failed'; tx.adminNotes='Insufficient funds'; await DB.put('transactions', tx); await DB.add('audit',{ id:'al_'+uid(8), action:'approveTxFailed', data:tx, createdAt: nowISO()}); renderAdminTables(); showToast('Insufficient funds','error'); return; }
    // deduct & credit
    from.balance = Math.round((from.balance - tx.amount)*100)/100; await DB.put('accounts', from);
    const toAcct = await DB.get('accounts', tx.toAccountId);
    if(toAcct){ toAcct.balance = Math.round((toAcct.balance + tx.amount)*100)/100; await DB.put('accounts', toAcct); }
    tx.status = 'completed'; tx.processedAt = nowISO(); tx.adminNotes = 'Approved by admin';
    await DB.put('transactions', tx);
    await DB.add('audit', { id:'al_'+uid(8), action:'approveTx', data:tx, createdAt: nowISO()});
    showToast('Transaction approved & processed', 'success');
    // notify via PushMock
    PushMock.send({ title: `Transaction ${tx.id} completed`, body: `Your payment of ${tx.amount} ${tx.currency} was processed.` });
    renderAdminTables();
    // immediate UI update for signed-in user
    if(App.user) { await refreshViews(); }
    // auto-generate receipt PDF for audit and user convenience
    generateReceiptPDF(tx);
  }catch(e){ console.error('approve error', e); showToast('Approval failed','error'); }
};

window.adminRejectTx = async function(txId){
  try{
    const txs = await DB.getAll('transactions'); const tx = txs.find(t=>t.id===txId);
    if(!tx) return showToast('Transaction not found','error');
    tx.status = 'declined'; tx.processedAt = nowISO(); tx.adminNotes = 'Declined by admin';
    await DB.put('transactions', tx);
    await DB.add('audit', { id:'al_'+uid(8), action:'rejectTx', data:tx, createdAt: nowISO()});
    showToast('Transaction declined', 'info');
    PushMock.send({ title: `Transaction ${tx.id} declined`, body: `Your payment was declined by the bank.` });
    renderAdminTables();
    if(App.user){ await refreshViews(); }
  }catch(e){ console.error('reject error', e); showToast('Rejection failed','error'); }
};

/* Audit list render */
async function renderAuditList(){
  const logs = await DB.getAll('audit'); const container = document.getElementById('auditList');
  if(!container) return;
  container.innerHTML = logs.slice(-200).reverse().map(l=>`<div style="padding:.35rem;border-bottom:1px dashed var(--glass-border);font-size:.9rem"><strong>${l.action}</strong> <span style="color:var(--muted);font-size:.8rem">at ${new Date(l.createdAt).toLocaleString()}</span><div style="color:var(--muted);margin-top:.2rem">${JSON.stringify(l.data).slice(0,200)}</div></div>`).join('');
}

/* ======= Backup / Export / Import ======= */
async function adminExportJSON(){
  const payload = {
    users: await DB.getAll('users'),
    accounts: await DB.getAll('accounts'),
    transactions: await DB.getAll('transactions'),
    audit: await DB.getAll('audit')
  };
  downloadFile(JSON.stringify(payload,null,2), 'dgbank_backup.json', 'application/json');
  showToast('JSON export downloaded', 'success');
}

async function adminExportCSV(){
  const users = await DB.getAll('users');
  const csv = ['id,firstName,lastName,email,role,createdAt', ...users.map(u=> [u.id, u.firstName||'', u.lastName||'', u.email||'', u.role||'user', u.createdAt||''].map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',') )].join('\n');
  downloadFile(csv, 'users.csv', 'text/csv');
  showToast('CSV export downloaded', 'success');
}

async function adminImportFile(){
  const f = document.getElementById('adminImportFile').files[0];
  if(!f) return showToast('Choose a file to import', 'error');
  const reader = new FileReader();
  reader.onload = async (e) => {
    const txt = e.target.result;
    if(f.name.endsWith('.json')){
      try{
        const obj = JSON.parse(txt);
        if(obj.users){ await DB.clear('users'); for(const u of obj.users) await DB.add('users', u); }
        if(obj.accounts){ await DB.clear('accounts'); for(const a of obj.accounts) await DB.add('accounts', a); }
        if(obj.transactions){ await DB.clear('transactions'); for(const t of obj.transactions) await DB.add('transactions', t); }
        if(obj.audit){ await DB.clear('audit'); for(const a of obj.audit) await DB.add('audit', a); }
        showToast('JSON import completed', 'success');
        await renderAdminTables();
      }catch(e){ console.error('import json', e); showToast('Import failed', 'error'); }
    } else if(f.name.endsWith('.csv')){
      // basic CSV user import
      try{
        const lines = txt.split(/\r?\n/); const hdr = lines.shift().split(',').map(h=>h.replace(/(^"|"$)/g,''));
        for(const line of lines){
          if(!line.trim()) continue;
          const cols = line.split(',').map(c=>c.replace(/(^"|"$)/g,''));
          const obj = {}; hdr.forEach((h,i)=> obj[h] = cols[i]);
          const pwhash = await sha256('Imported!2025');
          const user = { id: obj.id || 'u_'+uid(8), firstName: obj.firstName||'', lastName: obj.lastName||'', email: obj.email||'', password: pwhash, role: obj.role||'user', createdAt: obj.createdAt||nowISO() };
          await DB.add('users', user);
        }
        showToast('CSV import completed', 'success'); await renderAdminTables();
      }catch(e){ console.error('import csv', e); showToast('CSV import failed', 'error'); }
    } else showToast('Unsupported file type', 'error');
  };
  reader.readAsText(f);
}

/* ======= EmailJS integration (admin-configurable) ======= */
function adminSaveEmailCfg(){
  const cfg = { service_id: document.getElementById('email_service_admin').value.trim(), template_id: document.getElementById('email_template_admin').value.trim(), public_key: document.getElementById('email_public_admin').value.trim() };
  localStorage.setItem('dgb_email_cfg', JSON.stringify(cfg));
  if(cfg.public_key) emailjs.init(cfg.public_key);
  showToast('EmailJS configuration saved', 'success');
}
async function adminSendTestEmail(){
  const cfg = JSON.parse(localStorage.getItem('dgb_email_cfg')||'{}');
  if(!cfg.service_id || !cfg.template_id || !cfg.public_key) return showToast('Please configure EmailJS first', 'error');
  try{
    await emailjs.send(cfg.service_id, cfg.template_id, { to_email: 'admin@deutscheglobal.bank', subject: 'DeutscheGlobal test', message: 'This is a system test.', from_name: 'DeutscheGlobal' });
    showToast('Test email sent', 'success');
  }catch(e){ console.error('email send',e); showToast('Email send failed', 'error'); }
}

/* ======= WebSocket mock & Push integration ======= */
/* Provide simple WebSocket stub and a function to send a simulated push */
window.WebSocketMock = {
  clients: [],
  connect(cb){ const id = 'w_'+uid(6); this.clients.push({id,cb}); return ()=>{ this.clients = this.clients.filter(c=>c.id !== id); } },
  broadcast(msg){ this.clients.forEach(c=>c.cb(msg)) }
};

window.simulateWebSocketMessage = function(title, body){
  const payload = JSON.stringify({ title, body, ts: nowISO() });
  WebSocketMock.broadcast(payload);
  PushMock.send({title, body});
  showToast(title, 'info');
};

/* Allow developer/admin to open admin console (used by triple click) */
window.openAdmin = async function(){
  createAdminModalIfMissing();
  openModal('adminModal');
  // populate known email config fields
  const cfg = JSON.parse(localStorage.getItem('dgb_email_cfg')||'{}');
  document.getElementById('email_service_admin').value = cfg.service_id || '';
  document.getElementById('email_template_admin').value = cfg.template_id || '';
  document.getElementById('email_public_admin').value = cfg.public_key || '';
  await renderAdminTables();
};

/* ======= Service Worker & Manifest generator (downloadable helper) ======= */
function swCode(){
  // Simple, cache-first service worker (recommended to place a proper sw.js at repo root for GitHub Pages)
  return `const CACHE_NAME='dgbank-static-v1';const ASSETS=['/','/index.html'];self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(ASSETS)).catch(()=>{}))});self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});self.addEventListener('fetch',e=>{const req=e.request; if(req.method!=='GET') return; e.respondWith(caches.match(req).then(r=>r||fetch(req).then(resp=>{caches.open(CACHE_NAME).then(c=>c.put(req,resp.clone()));return resp})).catch(()=>{}))});`;
}

function manifestJSON(){
  return {
    name: "DeutscheGlobal Bank",
    short_name: "DGBank",
    start_url: "./index.html",
    display: "standalone",
    background_color: "#f5f7fb",
    theme_color: "#003366",
    description: "DeutscheGlobal Bank — secure digital banking",
    icons: [
      { src: "assets/icons/icon-192.png", sizes: "192x192", type: "image/png" },
      { src: "assets/icons/icon-512.png", sizes: "512x512", type: "image/png" }
    ]
  };
}

/* Download helper */
function downloadFile(content, filename='file.txt', mime='text/plain'){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

/* ======= Accessibility / Keyboard improvements ======= */
/* When modals open, trap focus inside them (basic) */
function trapModalFocus(modalBackdrop){
  const modal = modalBackdrop.querySelector('.modal'); if(!modal) return;
  const focusable = modal.querySelectorAll('a[href], button, input, textarea, select, [tabindex]:not([tabindex="-1"])');
  if(!focusable.length) return;
  const first = focusable[0], last = focusable[focusable.length-1];
  modalBackdrop.addEventListener('keydown', function(e){
    if(e.key === 'Tab'){
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    } else if(e.key === 'Escape'){ modalBackdrop.classList.remove('show'); setTimeout(()=>{ modalBackdrop.style.display = 'none'; }, 300); }
  });
}

/* Ensure focus traps on admin modal creation */
createAdminModalIfMissing();
trapModalFocus(document.getElementById('adminModal'));
trapModalFocus(document.getElementById('authModal'));
trapModalFocus(document.getElementById('transferModal'));
trapModalFocus(document.getElementById('feedbackModal'));
trapModalFocus(document.getElementById('chatModal'));

/* ======= Wire super-admin triple click to open admin (completes secret flow) ======= */
/* Already in chunk 1 */

/* ======= Initialize Admin UI when available ======= */
(async function adminInit(){
  createAdminModalIfMissing();
  // Connect WebSocketMock to show messages within admin console (optional)
  WebSocketMock.connect((msg)=>{ try{ const data = JSON.parse(msg); showToast(`WS: ${data.title}`, 'info'); }catch(e){} });
  // Ensure admin tables reflect DB state
  await renderAdminTables();
})();

/* ======= Expose audit/tracing helper for developer console ======= */
window.dumpAudit = async function(){ console.table(await DB.getAll('audit')); };

/* ======= Final: provide convenience function to fully export required deployment files (sw.js & manifest.json) ======= */
window.provideDeploymentFiles = function(){
  // generate sw.js
  downloadFile(swCode(), 'sw.js', 'application/javascript');
  downloadFile(JSON.stringify(manifestJSON(), null, 2), 'manifest.json', 'application/json');
  showToast('sw.js and manifest.json downloaded. Place them in your GitHub repo root for PWA support.', 'success', 6000);
};
</script>
</body>
</html>
