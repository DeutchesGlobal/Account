<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeutscheGlobal Bank</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #004780;
            --secondary-color: #0066cc;
            --text-color: #333;
            --bg-color: #f5f8fa;
            --card-bg: #fff;
            --border-color: #e0e6e9;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-family: 'Roboto', sans-serif;
            --transition-speed: 0.3s ease;
        }
        body.dark-mode {
            --primary-color: #34495e;
            --secondary-color: #3498db;
            --text-color: #ecf0f1;
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --border-color: #44586d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Navbar & Header */
        header {
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 1rem 0;
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            transition: color var(--transition-speed);
        }
        .nav-links { list-style: none; display: flex; gap: 2rem; }
        .nav-links a, .mobile-menu a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            transition: color var(--transition-speed);
        }
        .nav-links a:hover, .nav-links a.active { color: var(--secondary-color); }
        .cta-button {
            background-color: var(--secondary-color);
            color: #fff;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color var(--transition-speed);
        }
        .cta-button:hover { background-color: #0056b3; }
        .login-btn, .mobile-menu-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--primary-color);
            padding: 0.5rem;
            transition: color var(--transition-speed);
        }
        .mobile-menu {
            display: none;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            transition: all var(--transition-speed);
        }
        .mobile-menu.active { display: flex; }
        
        /* General Layout & Sections */
        main { padding: 2rem 0; }
        section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
            min-height: 70vh;
        }
        section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1, h2, h3 { color: var(--primary-color); margin-bottom: 1rem; transition: color var(--transition-speed); }
        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        .hero {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
        }
        .hero-img {
            width: 100%;
            height: 450px;
            object-fit: cover;
            object-position: center;
            filter: brightness(0.7);
        }
        .hero-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            max-width: 800px;
        }
        .hero-content h1 {
            color: #fff;
            font-size: 3rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .grid-container {
            display: grid;
            gap: 2rem;
            margin-top: 2rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        .card, .form-container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow);
            transition: background-color var(--transition-speed);
        }
        .form-container { max-width: 500px; margin: 2rem auto; }
        
        /* Forms & Buttons */
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all var(--transition-speed);
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        .btn {
            display: inline-block;
            background-color: var(--secondary-color);
            color: #fff;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color var(--transition-speed), transform 0.1s ease;
        }
        .btn:hover { background-color: #0056b3; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--secondary-color); }
        .btn-secondary { background-color: var(--primary-color); }
        
        /* Dashboard & Financials */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        @media (min-width: 768px) {
            .dashboard-grid { grid-template-columns: 2fr 1fr; }
        }
        .balance-card, .transaction-card {
            padding: 1.5rem;
            border-radius: 10px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            transition: background-color var(--transition-speed);
        }
        .transaction-list { list-style: none; margin-top: 1rem; }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-amount.positive { color: #28a745; font-weight: bold; }
        .transaction-amount.negative { color: #dc3545; font-weight: bold; }
        
        /* Admin Panel */
        .admin-section { padding-top: 2rem; }
        .admin-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .admin-nav .btn { padding: 0.6rem 1.2rem; }
        .admin-list { list-style: none; }
        .admin-list-item {
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color var(--transition-speed);
        }
        .admin-actions button { margin-left: 0.5rem; }

        /* Modals & Overlays */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            position: relative;
            transition: background-color var(--transition-speed);
            text-align: center;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }
        
        /* Footer */
        footer {
            background-color: var(--primary-color);
            color: #fff;
            padding: 2rem 0;
            text-align: center;
            transition: background-color var(--transition-speed);
        }
        .footer-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .social-icons a { color: #fff; margin: 0 10px; font-size: 1.5rem; transition: color var(--transition-speed); }
        .social-icons a:hover { color: var(--secondary-color); }
        
        /* Responsive */
        @media (max-width: 767px) {
            .nav-links { display: none; }
            .mobile-menu-btn { display: block; }
            .navbar { justify-content: space-between; }
            .login-btn { display: none; }
            .hero-content h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#home" class="logo" id="main-logo">DeutscheGlobal Bank</a>
                <ul class="nav-links">
                    <li><a href="#home" class="nav-link active">Startseite</a></li>
                    <li><a href="#about" class="nav-link">Über Uns</a></li>
                    <li><a href="#services" class="nav-link">Dienstleistungen</a></li>
                    <li><a href="#testimonials" class="nav-link">Testimonials</a></li>
                    <li class="user-link hidden"><a href="#dashboard" class="nav-link">Dashboard</a></li>
                    <li class="user-link hidden"><a href="#transfer" class="nav-link">Überweisung</a></li>
                    <li class="user-link hidden"><a href="#investments" class="nav-link">Investitionen</a></li>
                    <li class="admin-link hidden"><a href="#admin" class="nav-link">Admin-Panel</a></li>
                </ul>
                <div class="nav-actions">
                    <button id="theme-toggle" class="btn-icon"><i class="fas fa-moon"></i></button>
                    <button class="login-btn" onclick="showSection('login')">Login</button>
                    <button class="user-link hidden btn-primary" onclick="handleLogout()">Logout</button>
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
                </div>
            </nav>
            <nav class="mobile-menu" id="mobile-menu">
                <a href="#home" onclick="showSection('home'); toggleMobileMenu()">Startseite</a>
                <a href="#about" onclick="showSection('about'); toggleMobileMenu()">Über Uns</a>
                <a href="#services" onclick="showSection('services'); toggleMobileMenu()">Dienstleistungen</a>
                <a href="#testimonials" onclick="showSection('testimonials'); toggleMobileMenu()">Testimonials</a>
                <a href="#login" onclick="showSection('login'); toggleMobileMenu()">Login</a>
                <a href="#dashboard" class="user-link hidden" onclick="showSection('dashboard'); toggleMobileMenu()">Dashboard</a>
                <a href="#transfer" class="user-link hidden" onclick="showSection('transfer'); toggleMobileMenu()">Überweisung</a>
                <a href="#investments" class="user-link hidden" onclick="showSection('investments'); toggleMobileMenu()">Investitionen</a>
                <a href="#admin" class="admin-link hidden" onclick="showSection('admin'); toggleMobileMenu()">Admin-Panel</a>
                <a href="#" class="user-link hidden" onclick="handleLogout(); toggleMobileMenu()">Logout</a>
            </nav>
        </div>
    </header>

    <main class="container">
        
        <section id="home" class="active">
            <div class="hero">
                <img src="https://images.unsplash.com/photo-1579621970563-fa15d315f62e?q=80&w=2070&auto=format&fit=crop" alt="Abstract banking image" class="hero-img">
                <div class="hero-content">
                    <h1>Ihre globale Bank vor Ort.</h1>
                    <p>Finanzlösungen für eine digitale Welt.</p>
                    <a href="#login" class="cta-button">Jetzt anmelden</a>
                </div>
            </div>
            <div class="grid-container">
                <div class="card">
                    <h3>Sichere Transaktionen</h3>
                    <p>Wir nutzen modernste Verschlüsselung, um Ihr Geld und Ihre Daten zu schützen.</p>
                </div>
                <div class="card">
                    <h3>24/7 Support</h3>
                    <p>Unser engagiertes Team ist jederzeit für Ihre Fragen da.</p>
                </div>
                <div class="card">
                    <h3>KI-gestützte Analysen</h3>
                    <p>Profitieren Sie von intelligenten Empfehlungen für Ihre Finanzen.</p>
                </div>
            </div>
        </section>

        <section id="about">
            <div class="hero">
                <img src="https://images.unsplash.com/photo-1549646633-11b0e2717a6a?q=80&w=2070&auto=format&fit=crop" alt="Bank office" class="hero-img">
                <div class="hero-content">
                    <h1>Über DeutscheGlobal Bank</h1>
                    <p>Wir sind Ihr Partner für eine sichere finanzielle Zukunft.</p>
                </div>
            </div>
            <p style="margin-top: 2rem;">Seit unserer Gründung im Jahr 1999 haben wir uns von einer regionalen Bank zu einem globalen Finanzinstitut entwickelt. Unsere Mission ist es, die komplexen Aspekte des Bankwesens zu vereinfachen und unseren Kunden intuitive, sichere und leistungsstarke Finanzlösungen anzubieten.</p>
            <div class="grid-container">
                <div class="card">
                    <h3>Unsere Mission</h3>
                    <p>Die DeutscheGlobal Bank hat sich zum Ziel gesetzt, die finanzielle Gesundheit unserer Kunden durch Innovation und Vertrauen zu fördern.</p>
                </div>
                <div class="card">
                    <h3>Unsere Werte</h3>
                    <p>Integrität, Transparenz und Kundenorientierung sind die Grundpfeiler, auf denen unser Erfolg ruht.</p>
                </div>
            </div>
        </section>
        
        <section id="services">
            <h2>Unsere Dienstleistungen</h2>
            <p>Ein umfassendes Angebot, das alle Ihre finanziellen Bedürfnisse abdeckt.</p>
            <div class="grid-container">
                <div class="card">
                    <h3>Konten & Zahlungen</h3>
                    <p>Globale Überweisungen und Echtzeit-Zahlungen, jederzeit verfügbar.</p>
                </div>
                <div class="card">
                    <h3>Kredite & Finanzierung</h3>
                    <p>Von Privatkrediten bis zur Baufinanzierung - wir sind Ihr Partner.</p>
                </div>
                <div class="card">
                    <h3>Anlagen & Investitionen</h3>
                    <p>Verwalten Sie Ihr Vermögen mit unserem intelligenten Investment-Portfolio.</p>
                </div>
                <div class="card">
                    <h3>Währungsumtausch</h3>
                    <p>Tauschen Sie Währungen zu aktuellen Echtzeit-Kursen.</p>
                </div>
            </div>
        </section>

        <section id="testimonials">
            <h2>Was unsere Kunden sagen</h2>
            <div class="grid-container">
                <div class="card">
                    <p>"Die Überweisungsfunktion ist blitzschnell und die App ist extrem benutzerfreundlich. Sehr empfehlenswert!"</p>
                    <p style="font-weight: bold; margin-top: 1rem;">- Sarah M., Berlin</p>
                </div>
                <div class="card">
                    <p>"Ich habe noch nie eine so transparente Bank erlebt. Keine versteckten Gebühren und der Support ist top!"</p>
                    <p style="font-weight: bold; margin-top: 1rem;">- Max P., Hamburg</p>
                </div>
                <div class="card">
                    <p>"Mit den Investitions-Tools konnte ich mein Erspartes endlich sinnvoll anlegen. Einfach großartig!"</p>
                    <p style="font-weight: bold; margin-top: 1rem;">- Lena B., München</p>
                </div>
            </div>
        </section>

        <section id="login" class="form-container">
            <h2>Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">Benutzername</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Passwort</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">Anmelden</button>
            </form>
            <p style="margin-top: 1rem;">Neu hier? <a href="#register" onclick="showSection('register')">Jetzt registrieren</a></p>
        </section>

        <section id="register" class="form-container">
            <h2>Registrierung</h2>
            <form id="registerForm">
                <div class="form-group"><label for="regFirstName">Vorname</label><input type="text" id="regFirstName" required></div>
                <div class="form-group"><label for="regLastName">Nachname</label><input type="text" id="regLastName" required></div>
                <div class="form-group"><label for="regUsername">Benutzername</label><input type="text" id="regUsername" required></div>
                <div class="form-group"><label for="regEmail">E-Mail</label><input type="email" id="regEmail" required></div>
                <div class="form-group"><label for="regPassword">Passwort</label><input type="password" id="regPassword" required></div>
                <button type="submit" class="btn btn-primary">Registrieren</button>
            </form>
        </section>
        
        <section id="dashboard" class="user-section">
            <h2 id="welcomeMessage">Willkommen, [Benutzername]!</h2>
            <div class="dashboard-grid">
                <div>
                    <div class="card mb-2">
                        <h3>Kontostände</h3>
                        <p><strong>Girokonto:</strong> <span id="checkingBalance">€ 0.00</span></p>
                        <p><strong>Sparkonto:</strong> <span id="savingsBalance">€ 0.00</span></p>
                    </div>
                    <div class="card">
                        <h3>Letzte Transaktionen</h3>
                        <ul id="transactionList" class="transaction-list"></ul>
                        <button class="btn btn-secondary mt-2" onclick="downloadStatement()">Kontoauszug (PDF)</button>
                    </div>
                </div>
                <div>
                    <div class="card mb-2">
                        <h3>Währungsumtausch</h3>
                        <div class="form-group">
                            <label for="currency-from">Von</label>
                            <select id="currency-from">
                                <option value="EUR">EUR - Euro</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="GBP">GBP - Britisches Pfund</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="currency-to">Nach</label>
                            <select id="currency-to">
                                <option value="EUR">EUR - Euro</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="GBP">GBP - Britisches Pfund</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="currency-amount">Betrag</label>
                            <input type="number" id="currency-amount" value="100">
                        </div>
                        <p>Umgetauschtes Ergebnis: <span id="exchange-result"></span></p>
                    </div>
                </div>
            </div>
        </section>

        <section id="transfer" class="user-section">
            <div class="form-container">
                <h2>Überweisung</h2>
                <form id="transferForm">
                    <div class="form-group">
                        <label for="transferRecipient">Empfänger</label>
                        <select id="transferRecipient" required></select>
                    </div>
                    <div class="form-group">
                        <label for="transferAmount">Betrag (€)</label>
                        <input type="number" id="transferAmount" min="0.01" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="transferPurpose">Verwendungszweck</label>
                        <input type="text" id="transferPurpose" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Überweisen</button>
                </form>
            </div>
        </section>

        <section id="investments" class="user-section">
            <div class="card">
                <h2>Mein Investment-Portfolio</h2>
                <div class="grid-container" id="portfolio-grid"></div>
            </div>
            <div class="card mt-2">
                <h3>Aktienhandel simulieren</h3>
                <form id="stock-trade-form">
                    <div class="form-group">
                        <label for="stock-symbol">Aktiensymbol</label>
                        <select id="stock-symbol">
                            <option value="AAPL">Apple (AAPL)</option>
                            <option value="TSLA">Tesla (TSLA)</option>
                            <option value="GOOGL">Google (GOOGL)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="trade-type">Handelsart</label>
                        <select id="trade-type">
                            <option value="buy">Kaufen</option>
                            <option value="sell">Verkaufen</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="trade-quantity">Anzahl</label>
                        <input type="number" id="trade-quantity" min="1" value="1">
                    </div>
                    <button type="submit" class="btn btn-primary">Handel ausführen</button>
                </form>
            </div>
        </section>
        
        <section id="admin" class="admin-section">
            <div class="card">
                <h2>Admin Panel</h2>
                <div class="admin-nav">
                    <button class="btn" onclick="showAdminSubpage('user-management')">Benutzerverwaltung</button>
                    <button class="btn" onclick="showAdminSubpage('transaction-approval')">Transaktionsfreigabe</button>
                </div>

                <div id="user-management" class="admin-subpage active">
                    <h3>Benutzerverwaltung</h3>
                    <ul id="admin-user-list" class="admin-list"></ul>
                </div>

                <div id="transaction-approval" class="admin-subpage hidden">
                    <h3>Ausstehende Transaktionen</h3>
                    <ul id="admin-transaction-list" class="admin-list"></ul>
                </div>
            </div>
        </section>

    </main>

    <footer>
        <div class="container footer-content">
            <div class="social-icons">
                <a href="#"><i class="fab fa-facebook-f"></i></a>
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-linkedin-in"></i></a>
            </div>
            <p>&copy; 2023 DeutscheGlobal Bank. Alle Rechte vorbehalten.</p>
        </div>
    </footer>

    <div id="2fa-modal" class="modal-overlay">
        <div class="modal">
            <h2>Zwei-Faktor-Authentifizierung</h2>
            <p>Geben Sie den Code ein, der an Ihre E-Mail gesendet wurde.</p>
            <form id="2fa-form">
                <div class="form-group"><input type="text" id="2fa-code" required></div>
                <button type="submit" class="btn btn-primary">Bestätigen</button>
            </form>
        </div>
    </div>
    
    <div id="transfer-initiated-modal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('transfer-initiated-modal')">&times;</button>
            <i class="fas fa-check-circle" style="color: #28a745; font-size: 3rem; margin-bottom: 1rem;"></i>
            <h2>Überweisung gestartet</h2>
            <p>Ihre Überweisung wurde erfolgreich in Auftrag gegeben und wird verarbeitet.</p>
        </div>
    </div>
    
    <div id="transfer-notification-modal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('transfer-notification-modal')">&times;</button>
            <h2 id="transfer-notification-title"></h2>
            <p id="transfer-notification-message"></p>
        </div>
    </div>

    <div id="admin-login-modal" class="modal-overlay">
        <div class="modal">
            <h2>Admin Login</h2>
            <form id="admin-login-form">
                <div class="form-group"><label for="admin-password">Passwort</label><input type="password" id="admin-password" required></div>
                <button type="submit" class="btn btn-primary">Anmelden</button>
            </form>
        </div>
    </div>
    
    <script>
        // --- Core Application Logic & State Management ---
        let currentUser = null;
        let adminMode = false;
        let db;
        let lastLogoClicks = [];

        // Mock data and API simulations
        const MOCK_STOCKS = { 'AAPL': 175.24, 'TSLA': 225.89, 'GOOGL': 135.50 };
        const MOCK_EXCHANGE_RATES = { 'EUR': { 'USD': 1.09, 'GBP': 0.86 }, 'USD': { 'EUR': 0.92, 'GBP': 0.79 }, 'GBP': { 'EUR': 1.16, 'USD': 1.27 } };

        // DOM Elements
        const sections = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.nav-link');
        const userLinks = document.querySelectorAll('.user-link');
        const adminLinks = document.querySelectorAll('.admin-link');
        const adminSubpages = document.querySelectorAll('.admin-subpage');
        const themeToggleBtn = document.getElementById('theme-toggle');

        // --- Database & State Management (IndexedDB Simulation) ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('DeutscheGlobalBankDB', 1);
                request.onupgradeneeded = event => {
                    db = event.target.result;
                    db.createObjectStore('users', { keyPath: 'username' });
                    db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                };
                request.onsuccess = event => {
                    db = event.target.result;
                    resolve();
                };
                request.onerror = event => {
                    console.error("IndexedDB error:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function saveData(storeName, data) {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            return new Promise((resolve, reject) => {
                const request = store.put(data);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getData(storeName, key) {
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            return new Promise((resolve, reject) => {
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAllData(storeName) {
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteData(storeName, key) {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            return new Promise((resolve, reject) => {
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        // --- UI & Navigation Logic ---
        function showSection(id) {
            sections.forEach(section => section.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            updateActiveNavLink(id);
            if (id === 'dashboard') renderDashboard();
            if (id === 'admin') renderAdminPanel();
            if (id === 'investments') renderInvestmentPortfolio();
        }

        function updateActiveNavLink(id) {
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${id}`) {
                    link.classList.add('active');
                }
            });
        }

        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('active');
        }
        
        // Dark/Light Mode
        themeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            themeToggleBtn.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });
        
        function loadTheme() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }
        
        // --- Authentication & User Flow ---
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('registerForm').addEventListener('submit', handleRegister);
        document.getElementById('2fa-form').addEventListener('submit', handle2FA);

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const user = await getData('users', username);
            if (user && user.password === password) {
                // Simulate 2FA
                openModal('2fa-modal');
                document.getElementById('2fa-form').dataset.username = username;
                console.log(`Simulated 2FA code sent to ${user.email}. Code is 123456.`);
            } else {
                alert('Anmeldung fehlgeschlagen: Falscher Benutzername oder Passwort.');
            }
        }

        async function handle2FA(event) {
            event.preventDefault();
            const code = document.getElementById('2fa-code').value;
            const username = document.getElementById('2fa-form').dataset.username;
            if (code === '123456') {
                currentUser = await getData('users', username);
                closeModal('2fa-modal');
                updateUI();
                showSection('dashboard');
                alert('Anmeldung erfolgreich!');
            } else {
                alert('Ungültiger 2FA-Code.');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const newUser = {
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value, // Insecure, would be hashed in real app
                role: 'user',
                checkingBalance: 5000 + Math.random() * 5000,
                savingsBalance: 10000 + Math.random() * 10000,
                portfolio: [{ symbol: 'AAPL', quantity: 2 }, { symbol: 'TSLA', quantity: 1 }],
                status: 'active'
            };
            const existingUser = await getData('users', newUser.username);
            if (existingUser) {
                alert('Registrierung fehlgeschlagen: Benutzername bereits vergeben.');
                return;
            }
            await saveData('users', newUser);
            alert('Registrierung erfolgreich! Bitte melden Sie sich an.');
            showSection('login');
        }

        function handleLogout() {
            currentUser = null;
            adminMode = false;
            updateUI();
            showSection('home');
        }

        // --- Dashboard & Financial Logic ---
        async function renderDashboard() {
            if (!currentUser) return;
            document.getElementById('welcomeMessage').textContent = `Willkommen, ${currentUser.firstName}!`;
            document.getElementById('checkingBalance').textContent = `€ ${currentUser.checkingBalance.toFixed(2)}`;
            document.getElementById('savingsBalance').textContent = `€ ${currentUser.savingsBalance.toFixed(2)}`;
            renderTransactions();
            renderTransferRecipients();
            updateCurrencyExchange();
        }

        async function renderTransactions() {
            const transactionList = document.getElementById('transactionList');
            transactionList.innerHTML = '';
            const allTransactions = await getAllData('transactions');
            const userTransactions = allTransactions
                .filter(t => t.fromUser === currentUser.username || t.toUser === currentUser.username)
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 5);
            
            userTransactions.forEach(t => {
                const isIncoming = t.toUser === currentUser.username;
                const item = document.createElement('li');
                item.className = 'transaction-item';
                const statusClass = t.status === 'approved' ? 'positive' : 'negative';
                item.innerHTML = `
                    <div>
                        <strong>${new Date(t.timestamp).toLocaleDateString()}</strong><br>
                        ${isIncoming ? `Von: ${t.fromUser}` : `An: ${t.toUser}`}<br>
                        <small>Status: ${t.status === 'pending' ? 'Ausstehend' : (t.status === 'approved' ? 'Erfolgreich' : 'Abgelehnt')}</small>
                    </div>
                    <span class="transaction-amount ${statusClass}">
                        ${isIncoming ? '+' : '-'} €${Math.abs(t.amount).toFixed(2)}
                    </span>
                `;
                transactionList.appendChild(item);
            });
        }
        
        async function renderTransferRecipients() {
            const recipientSelect = document.getElementById('transferRecipient');
            recipientSelect.innerHTML = '<option value="">Benutzer wählen...</option>';
            const allUsers = await getAllData('users');
            allUsers.filter(u => u.username !== currentUser.username).forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.firstName} ${user.lastName} (${user.username})`;
                recipientSelect.appendChild(option);
            });
        }

        document.getElementById('transferForm').addEventListener('submit', handleTransfer);

        async function handleTransfer(event) {
            event.preventDefault();
            const recipientUsername = document.getElementById('transferRecipient').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const purpose = document.getElementById('transferPurpose').value;

            if (amount <= 0 || currentUser.checkingBalance < amount) {
                alert('Ungültiger Betrag oder unzureichende Deckung.');
                return;
            }
            
            const recipient = await getData('users', recipientUsername);
            if (!recipient) {
                alert('Empfänger nicht gefunden.');
                return;
            }

            // Deduct funds immediately
            currentUser.checkingBalance -= amount;
            await saveData('users', currentUser);
            
            const newTransaction = {
                timestamp: Date.now(),
                fromUser: currentUser.username,
                toUser: recipient.username,
                amount: amount,
                purpose: purpose,
                status: 'pending' // Set initial status to pending
            };
            const transactionId = await saveData('transactions', newTransaction).then(() => newTransaction.id);

            openModal('transfer-initiated-modal');
            
            // Simulate processing time
            setTimeout(async () => {
                const updatedTransaction = await getData('transactions', transactionId);
                if (updatedTransaction.status === 'approved') {
                    recipient.checkingBalance += amount;
                    await saveData('users', recipient);
                }
                
                // Fire custom event to update UI
                window.dispatchEvent(new CustomEvent('transactionUpdated'));
                
                document.getElementById('transfer-notification-title').textContent = `Überweisung ${updatedTransaction.status === 'approved' ? 'erfolgreich' : 'abgelehnt'}!`;
                document.getElementById('transfer-notification-message').textContent = `Ihre Überweisung an ${recipient.firstName} ${recipient.lastName} wurde ${updatedTransaction.status === 'approved' ? 'verarbeitet.' : 'abgelehnt. Das Geld wurde zurückgebucht.'}`;
                openModal('transfer-notification-modal');
            }, 3000); // 3-second delay for processing
            
            // Re-render dashboard to show updated balance and pending transaction
            renderDashboard();
        }

        function downloadStatement() {
            // PDF generation simulation using a blob
            const statementContent = `
                Kontoauszug - DeutscheGlobal Bank
                Datum: ${new Date().toLocaleDateString('de-DE')}
                Benutzer: ${currentUser.firstName} ${currentUser.lastName} (${currentUser.username})
                Girokonto: €${currentUser.checkingBalance.toFixed(2)}
                Sparkonto: €${currentUser.savingsBalance.toFixed(2)}
                
                --- Transaktionen ---
                ... (Actual transaction data would be generated here) ...
            `;
            const blob = new Blob([statementContent], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Kontoauszug-${currentUser.username}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Kontoauszug wird heruntergeladen...');
        }
        
        // --- Investment Logic ---
        async function renderInvestmentPortfolio() {
            const portfolioGrid = document.getElementById('portfolio-grid');
            portfolioGrid.innerHTML = '';
            
            if (!currentUser || !currentUser.portfolio) {
                portfolioGrid.innerHTML = '<p>Keine Investitionen vorhanden.</p>';
                return;
            }
            
            currentUser.portfolio.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                const currentPrice = MOCK_STOCKS[item.symbol] || 0;
                card.innerHTML = `
                    <h3>${item.symbol}</h3>
                    <p>Menge: ${item.quantity}</p>
                    <p>Aktueller Preis: €${currentPrice.toFixed(2)}</p>
                    <p>Gesamtwert: €${(currentPrice * item.quantity).toFixed(2)}</p>
                `;
                portfolioGrid.appendChild(card);
            });
        }
        
        document.getElementById('stock-trade-form').addEventListener('submit', handleStockTrade);
        
        async function handleStockTrade(event) {
            event.preventDefault();
            const symbol = document.getElementById('stock-symbol').value;
            const type = document.getElementById('trade-type').value;
            const quantity = parseInt(document.getElementById('trade-quantity').value);
            const stockPrice = MOCK_STOCKS[symbol];
            const cost = stockPrice * quantity;

            const existingPortfolioItem = currentUser.portfolio.find(item => item.symbol === symbol);
            
            if (type === 'buy') {
                if (currentUser.checkingBalance < cost) {
                    alert('Unzureichendes Guthaben für den Kauf.');
                    return;
                }
                currentUser.checkingBalance -= cost;
                if (existingPortfolioItem) {
                    existingPortfolioItem.quantity += quantity;
                } else {
                    currentUser.portfolio.push({ symbol: symbol, quantity: quantity });
                }
            } else if (type === 'sell') {
                if (!existingPortfolioItem || existingPortfolioItem.quantity < quantity) {
                    alert('Unzureichende Aktienmenge für den Verkauf.');
                    return;
                }
                currentUser.checkingBalance += cost;
                existingPortfolioItem.quantity -= quantity;
                if (existingPortfolioItem.quantity === 0) {
                    currentUser.portfolio = currentUser.portfolio.filter(item => item.symbol !== symbol);
                }
            }
            
            await saveData('users', currentUser);
            alert('Handel erfolgreich ausgeführt!');
            renderInvestmentPortfolio();
            renderDashboard();
        }

        function updateCurrencyExchange() {
            const from = document.getElementById('currency-from');
            const to = document.getElementById('currency-to');
            const amount = document.getElementById('currency-amount');
            const result = document.getElementById('exchange-result');

            function calculate() {
                const rate = MOCK_EXCHANGE_RATES[from.value][to.value] || 1;
                result.textContent = `${(amount.value * rate).toFixed(2)} ${to.value}`;
            }
            from.addEventListener('change', calculate);
            to.addEventListener('change', calculate);
            amount.addEventListener('input', calculate);
            calculate();
        }

        // --- Admin Panel Logic ---
        document.getElementById('main-logo').addEventListener('click', handleAdminLoginClick);
        document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
        
        function handleAdminLoginClick() {
            lastLogoClicks.push(Date.now());
            if (lastLogoClicks.length > 3) { lastLogoClicks.shift(); }
            if (lastLogoClicks.length === 3 && (lastLogoClicks[2] - lastLogoClicks[0]) < 1000) {
                openModal('admin-login-modal');
            }
        }

        function handleAdminLogin(event) {
            event.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (password === 'admin111') {
                closeModal('admin-login-modal');
                adminMode = true;
                currentUser = { role: 'admin', username: 'admin' };
                updateUI();
                showSection('admin');
                alert('Admin-Login erfolgreich!');
            } else {
                alert('Falsches Passwort.');
            }
        }

        async function renderAdminPanel() {
            if (!adminMode) { showSection('home'); return; }
            renderAdminUsers();
            renderAdminTransactions();
        }

        function showAdminSubpage(id) {
            adminSubpages.forEach(page => page.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        async function renderAdminUsers() {
            const userList = document.getElementById('admin-user-list');
            userList.innerHTML = '';
            const allUsers = await getAllData('users');
            allUsers.forEach(user => {
                const item = document.createElement('li');
                item.className = 'admin-list-item';
                item.innerHTML = `
                    <div>
                        <strong>${user.firstName} ${user.lastName}</strong> (${user.username})<br>
                        <small>Status: ${user.status}</small>
                    </div>
                    <div class="admin-actions">
                        <button onclick="toggleUserStatus('${user.username}')" class="btn btn-secondary">${user.status === 'active' ? 'Sperren' : 'Aktivieren'}</button>
                        <button onclick="deleteUser('${user.username}')" class="btn btn-primary">Löschen</button>
                    </div>
                `;
                userList.appendChild(item);
            });
        }

        async function toggleUserStatus(username) {
            const user = await getData('users', username);
            user.status = user.status === 'active' ? 'frozen' : 'active';
            await saveData('users', user);
            alert(`Benutzer ${username} wurde ${user.status === 'active' ? 'aktiviert' : 'gesperrt'}.`);
            renderAdminUsers();
        }

        async function deleteUser(username) {
            if (confirm(`Sind Sie sicher, dass Sie ${username} löschen möchten?`)) {
                await deleteData('users', username);
                alert(`Benutzer ${username} wurde gelöscht.`);
                renderAdminUsers();
            }
        }
        
        async function renderAdminTransactions() {
            const transactionList = document.getElementById('admin-transaction-list');
            transactionList.innerHTML = '';
            const allTransactions = await getAllData('transactions');
            const pendingTransactions = allTransactions.filter(t => t.status === 'pending');

            if (pendingTransactions.length === 0) {
                transactionList.innerHTML = '<li>Keine ausstehenden Transaktionen.</li>';
                return;
            }

            pendingTransactions.forEach(t => {
                const item = document.createElement('li');
                item.className = 'admin-list-item';
                item.innerHTML = `
                    <div>
                        <strong>Von:</strong> ${t.fromUser}<br>
                        <strong>An:</strong> ${t.toUser}<br>
                        <strong>Betrag:</strong> €${t.amount.toFixed(2)}<br>
                        <small>Zweck: ${t.purpose}</small>
                    </div>
                    <div class="admin-actions">
                        <button onclick="approveTransaction(${t.id})" class="btn btn-secondary">Freigeben</button>
                        <button onclick="rejectTransaction(${t.id})" class="btn btn-primary">Ablehnen</button>
                    </div>
                `;
                transactionList.appendChild(item);
            });
        }
        
        async function approveTransaction(id) {
            const transaction = await getData('transactions', id);
            transaction.status = 'approved';
            await saveData('transactions', transaction);
            alert('Transaktion freigegeben.');
            renderAdminTransactions();
            window.dispatchEvent(new CustomEvent('transactionUpdated'));
        }
        
        async function rejectTransaction(id) {
            const transaction = await getData('transactions', id);
            const fromUser = await getData('users', transaction.fromUser);
            if (fromUser) {
                fromUser.checkingBalance += transaction.amount;
                await saveData('users', fromUser);
            }
            transaction.status = 'rejected';
            await saveData('transactions', transaction);
            alert('Transaktion abgelehnt. Geld wurde zurückgebucht.');
            renderAdminTransactions();
            window.dispatchEvent(new CustomEvent('transactionUpdated'));
        }

        // --- Helper Functions ---
        function updateUI() {
            const userLoggedIn = !!currentUser;
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            userLinks.forEach(link => link.classList.toggle('hidden', !userLoggedIn || isAdmin));
            adminLinks.forEach(link => link.classList.toggle('hidden', !isAdmin));
            document.querySelector('.login-btn').style.display = userLoggedIn ? 'none' : 'block';
            document.querySelector('.user-link.btn-primary').style.display = userLoggedIn ? 'block' : 'none';

            if (userLoggedIn) {
                renderDashboard();
            }
        }
        
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        // --- Event Listener for real-time updates ---
        window.addEventListener('transactionUpdated', () => {
            if (document.getElementById('dashboard').classList.contains('active')) {
                renderDashboard();
            }
        });

        // --- Initialisation ---
        async function init() {
            await initDB();
            loadTheme();
            const hash = window.location.hash.substring(1);
            showSection(hash && document.getElementById(hash) ? hash : 'home');
            updateUI();

            // Set up mock initial data if DB is empty
            const initialUsers = await getAllData('users');
            if (initialUsers.length === 0) {
                const mockUsers = [
                    { username: 'max.mustermann', password: 'password', firstName: 'Max', lastName: 'Mustermann', email: 'max@example.com', role: 'user', checkingBalance: 5234.56, savingsBalance: 12456.78, portfolio: [{ symbol: 'AAPL', quantity: 5 }], status: 'active' },
                    { username: 'lisa.schmidt', password: 'password', firstName: 'Lisa', lastName: 'Schmidt', email: 'lisa@example.com', role: 'user', checkingBalance: 8765.43, savingsBalance: 21987.65, portfolio: [{ symbol: 'TSLA', quantity: 3 }], status: 'active' }
                ];
                for (const user of mockUsers) {
                    await saveData('users', user);
                }
                const mockTransactions = [
                    { id: 1, fromUser: 'max.mustermann', toUser: 'lisa.schmidt', amount: 50, purpose: 'Dinner', status: 'pending', timestamp: Date.now() },
                    { id: 2, fromUser: 'lisa.schmidt', toUser: 'max.mustermann', amount: 25, purpose: 'Coffee', status: 'approved', timestamp: Date.now() + 1000 }
                ];
                for (const transaction of mockTransactions) {
                    await saveData('transactions', transaction);
                }
            }
        }

        init();
    </script>
</body>
</html>
